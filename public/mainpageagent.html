<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>홈스팟 – 중개사</title>
<style>
  .input{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none}
  .pager{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
  .pager .btn[disabled]{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
  .pager .num{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .pager .num.active{background:#2563eb;color:#fff;border-color:#2563eb}
  :root{
    --bg:#f7f8fb; --panel:#ffffff; --line:#e6e8ee; --text:#0f172a; --muted:#6b7280;
    --shadow:0 10px 30px rgba(17,24,39,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.55 ui-sans-serif,system-ui,'Noto Sans KR',sans-serif}
  a{color:inherit;text-decoration:none}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:20}
  .wrap{max-width:1200px;margin:0 auto;padding:16px 24px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .brand{display:flex;gap:10px;align-items:center;font-weight:800}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#22c1c3,#3a7bd5)}
  .right{margin-left:auto;display:flex;gap:10px}
  .btn{padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
  .btn.primary{background:#2563eb;color:#fff;border-color:transparent}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.08)}
  .pill{
    border-radius:999px;
    padding:6px 10px;
    border:1px solid var(--line);
    background:#fff;
    font-size:12px;color:#334155;
    display:inline-flex;align-items:center;gap:4px;
    white-space:nowrap;word-break:keep-all; /* 배지 내부 줄바꿈 금지 */
    /* ellipsis 제거 → 배지는 절대 생략 안 함, 줄은 meta에서 바뀜 */
  }

  /* 배너 */
  .notice{display:flex;gap:16px;align-items:center;border:1px solid var(--line);border-radius:16px;padding:16px 18px;
    background:linear-gradient(135deg,#eff6ff,#f5f3ff);box-shadow:var(--shadow)}

  /* Grid & Card */
  .grid{display:grid;gap:16px}
  .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:1024px){.grid-3{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
  .muted{color:var(--muted)}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin-top:22px}

  /* placeholder */
  .placeholder{padding:14px;border:1px dashed var(--line);border-radius:12px;background:#fff;color:#6b7280;text-align:center}
  .grid-auto{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}

  /* 카드 내부 레이아웃 */
  .card .leftcol{flex:0 0 140px;min-width:140px}
  .card .thumb{width:140px;height:100px;border-radius:12px;background:#f2f4f8;overflow:hidden}
  .card .actions-under{
    display:flex;gap:8px;justify-content:space-between;margin-top:8px;
  }
  .card .content{
    flex:1; min-width:0;
    display:flex; flex-direction:column; justify-content:flex-start;
  }
  .meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:6px}

  /* 제목/설명 말줄임 */
  .card .title{
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
    overflow:hidden; word-break:keep-all; line-height:1.4; max-height:2.8em;
    font-weight:800;
  }
  .card .desc{
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
    overflow:hidden; word-break:keep-all; line-height:1.45; max-height:2.9em;
  }

  .actions{display:flex; gap:10px; flex-wrap:wrap}
  .action{
    flex:1 1 220px;
    display:flex; align-items:center; justify-content:space-between;
    padding:16px 18px; border-radius:14px; color:#fff;
  }
  .action.manage { background:linear-gradient(135deg,#8b5cf6,#6366f1); }
  .action.create { background:linear-gradient(135deg,#2563eb,#60a5fa); }
  .action.inbox  { background:linear-gradient(135deg,#f472b6,#ec4899); }
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="brand"><div class="logo"></div>홈스팟 – 중개사</div>
    <div class="right">
      <a class="btn" href="profile_setting.html">프로필</a>
      <a class="btn" href="/logout">로그아웃</a>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- 빠른 액션 -->
  <section class="actions" style="margin-top:16px">
  <div class="action create">
    <div>
      <b>매물 등록</b>
      <div class="muted" style="color:#e5f1ff">사진/옵션/주소 입력</div>
    </div>
    <a class="btn" href="property_listing.html"
       style="color:#0f172a;font-weight:700"
       onclick="openPopup(event, 'property_listing.html', '매물 등록')">등록</a>
  </div>

  <div class="action inbox">
    <div>
      <b>문의함</b>
      <div class="muted" style="color:#ffe4f1">실시간 상담 연결</div>
    </div>
    <button class="btn" onclick="openPopup(event, 'chat.html', '문의함')">보기</button>
  </div>
</section>
<script>
  function openPopup(e, url, title) {
    if (e) e.preventDefault();           // 기본 이동 막기 (href 타지 않게)
    const w = 1200, h = 800;
    const left = (screen.width - w) / 2;
    const top  = (screen.height - h) / 2;
    window.open(
      url,
      title,
      `width=${w},height=${h},left=${left},top=${top},scrollbars=yes,resizable=yes`
    );
  }
</script>

  

  <!-- 최근 문의/알림/가이드 -->
  <section class="grid grid-3" style="margin-top:16px">
    <div class="card">
      <div class="section-title"><h3 style="margin:0">최근 문의</h3><span class="pill">실시간</span></div>
      <div id="inbox" class="placeholder" style="margin-top:8px">문의 데이터 불러오기 예정…</div>
    </div>
    <div class="card">
      <div class="section-title"><h3 style="margin:0">알림</h3><span class="pill">지난 24시간</span></div>
      <ul id="alerts" style="margin:8px 0 0 18px;padding:0">
        <li class="muted">알림 데이터 연결 전…</li>
      </ul>
    </div>
    <div class="card">
      <div class="section-title">
        <h3 style="margin:0">가이드</h3>
        <a href="/api/guide" class="pill" title="홈스팟_가이드.hwp 내려받기">다운로드</a>
      </div>
      <div class="muted" style="margin-top:10px">
        사진 규격, 주소 작성법, 허위매물 방지 정책 등 운영 가이드를 확인하세요.
      </div>
    </div>
  </section>
<script>
  // 공지 팝업 열기
  function openNoticePopup(e, id){
    if (e) e.preventDefault();
    const w=900, h=700, left=(screen.width-w)/2, top=(screen.height-h)/2;
    window.open(`notice_view.html?id=${encodeURIComponent(id)}`, '공지사항',
      `width=${w},height=${h},left=${left},top=${top},scrollbars=yes,resizable=yes`);
  }

  async function loadNotices(){
    const ul = document.getElementById('alerts');
    if (!ul) return;
    ul.innerHTML = '<li class="muted">불러오는 중…</li>';
    try{
      const r = await fetch('/api/notices?limit=6', { credentials:'same-origin' });
      const j = await r.json();
      if (!r.ok || !j.ok) throw new Error('load failed');

      if (!j.items?.length){
        ul.innerHTML = '<li class="muted">표시할 공지사항이 없습니다.</li>';
        return;
      }

      // 목록 렌더(제목 클릭 → 팝업)
      ul.innerHTML = '';
      j.items.forEach(n => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `notice_view.html?id=${encodeURIComponent(n.notice_id)}`;
        a.textContent = n.title;
        a.style.fontWeight = '600';
        a.onclick = (e)=>openNoticePopup(e, n.notice_id);

        const small = document.createElement('small');
        small.className = 'muted';
        small.style.marginLeft = '8px';
        small.textContent = new Date(n.created_at).toLocaleDateString('ko-KR');

        li.appendChild(a);
        li.appendChild(small);
        ul.appendChild(li);
      });
    }catch(e){
      console.error(e);
      ul.innerHTML = '<li class="muted">공지 불러오기 실패</li>';
    }
  }

  document.addEventListener('DOMContentLoaded', loadNotices);
</script>

  

  <!-- 등록된 매물 -->
  <div class="section-title">
    <h2 style="margin:22px 0 6px">등록된 매물</h2>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="listing-search" type="search" placeholder="제목/설명/주소 검색" class="input" style="width:280px">
      <span class="pill">조회수/문의수 실시간 반영 예정</span>
      <button class="btn" id="btn-export">엑셀 다운로드</button>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const btn = document.getElementById('btn-export');
          btn?.addEventListener('click', () => {
            const q = (document.getElementById('listing-search')?.value || '').trim();
            const url = '/api/my-listings/export.csv' + (q ? ('?q='+encodeURIComponent(q)) : '');
            window.location.href = url;
          });
        });
      </script>
    </div>
  </div>

  <div id="agent-list" class="placeholder" style="margin-top:8px">
    등록된 매물 데이터 불러오기 예정…
  </div>
  <div id="agent-pager" style="margin-top:12px"></div>

  <script>
  (function(){
    const state = { page:1, pageSize:10, q:'' };

    const fmt = n => (n==null ? '' : Number(n).toLocaleString('ko-KR'));
    const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const propText = p => ({ apartment:'아파트', officetel:'오피스텔', rowhouse:'빌라/연립', detached:'단독/다가구' }[p] || p);
    const statusText = s => ({ active:'노출중', sold:'거래완료', removed:'비공개' }[s] || s);
    function dealText(i){
      if(i.deal_type==='sale')     return `매매 ${fmt(i.price_sale_10k)}만원`;
      if(i.deal_type==='jeonse')   return `전세 ${fmt(i.deposit_10k)}만원`;
      if(i.deal_type==='monthly'){
        if(i.rent_pay_cycle==='yearly') return `연세 보증금 ${fmt(i.deposit_10k)} / 연세 ${fmt(i.rent_annual_10k)}만원`;
        return `월세 ${fmt(i.deposit_10k)} / ${fmt(i.rent_10k)}만원`;
      }
      return i.deal_type;
    }

    const qs = (o)=>Object.entries(o).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');

    async function loadMyListings(){
      const listBox  = document.getElementById('agent-list');
      const pagerBox = document.getElementById('agent-pager');
      listBox.textContent = '불러오는 중…';
      pagerBox.innerHTML = '';

      const res  = await fetch(`/api/my-listings?${qs({page:state.page,pageSize:state.pageSize,q:state.q})}`, { credentials:'same-origin' });
      if(!res.ok){ listBox.textContent = '불러오기 실패'; return; }
      const data = await res.json();
      if(!data.ok){ listBox.textContent = '불러오기 실패'; return; }

      const { items=[], total=0 } = data;
      if(items.length===0){
        listBox.innerHTML = '<div class="placeholder">등록된 매물이 없습니다.</div>';
        return;
      }

      // ----- 목록 렌더(카드 3열) -----
      const grid = document.createElement('div');
      grid.className = 'grid grid-3';

      items.forEach(i => {
        const img = i.main_image_url ? `/uploads/${i.main_image_url}` : null;

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="row" style="gap:12px;align-items:flex-start">
            <div class="leftcol">
              <div class="thumb">
                ${img ? `<img src="${img}" alt="" style="width:100%;height:100%;object-fit:cover">`
                      : `<div class="muted" style="display:flex;align-items:center;justify-content:center;height:100%">이미지 없음</div>`}
              </div>
              <div class="actions-under">
                <a class="btn" href="/property_listing.html?edit=${i.listing_id}"
                onclick="openPopup(event, '/property_listing.html?edit=${i.listing_id}', '매물 수정')">수정</a>
                <button class="btn danger" data-del="${i.listing_id}">삭제</button>
              </div>
            </div>

            <div class="content">
              <div class="meta">
                <span class="pill">${propText(i.property_type)}</span>
                <span class="pill">${dealText(i)}</span>
                <span class="pill">${statusText(i.status)}</span>
              </div>

              <div class="title" title="${esc(i.title||'')}">${esc(i.title||'')}</div>
              ${i.description ? `<div class="muted desc" title="${esc(i.description)}">${esc(i.description)}</div>` : ''}

              <div class="muted" style="margin-top:6px;font-size:12px">등록일 ${new Date(i.created_at).toLocaleDateString('ko-KR')}</div>
            </div>
          </div>`;
        grid.appendChild(card);
      });

      listBox.replaceWith(grid);
      grid.id = 'agent-list';

      // ----- 페이저 렌더 -----
      const pages = Math.max(1, Math.ceil(total / state.pageSize));
      if (pages > 1){
        const p = document.createElement('div');
        p.className = 'pager';
        const prev = document.createElement('button');
        prev.className = 'btn'; prev.textContent = '이전';
        prev.disabled = state.page <= 1;
        prev.onclick = () => { state.page--; loadMyListings(); };

        const next = document.createElement('button');
        next.className = 'btn'; next.textContent = '다음';
        next.disabled = state.page >= pages;
        next.onclick = () => { state.page++; loadMyListings(); };

        p.appendChild(prev);

        const win = 3;
        const start = Math.max(1, state.page - win);
        const end   = Math.min(pages, state.page + win);
        for (let i = start; i <= end; i++){
          const b = document.createElement('button');
          b.className = 'num' + (i===state.page ? ' active' : '');
          b.textContent = i;
          b.onclick = () => { state.page = i; loadMyListings(); };
          p.appendChild(b);
        }

        p.appendChild(next);
        pagerBox.replaceChildren(p);
      } else {
        pagerBox.innerHTML = '';
      }
    }

    // 검색 입력(디바운스)
    function debounce(fn,ms){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),ms)}}
    const searchInput = document.getElementById('listing-search');
    if (searchInput){
      const run = debounce(()=>{ state.q = searchInput.value.trim(); state.page = 1; loadMyListings(); }, 300);
      searchInput.addEventListener('input', run);
      searchInput.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); run(); } });
    }

    // 삭제 버튼(성공 시 목록 리로드)
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button.btn.danger[data-del]');
      if (!btn) return;
      const id = btn.getAttribute('data-del');
      if (!confirm('정말 삭제하시겠어요?')) return;

      const res = await fetch(`/api/listings/${id}`, { method:'DELETE', credentials:'same-origin' });
      const out = await res.json().catch(()=>({}));
      if (res.ok && out.ok) {
        if (document.querySelectorAll('#agent-list .card').length === 1 && state.page > 1) {
          state.page -= 1;
        }
        loadMyListings();
      } else {
        alert(out.message || '삭제 실패');
      }
    });

    document.addEventListener('DOMContentLoaded', loadMyListings);
  })();

  // 로그인 상태 버튼 토글(선택)
  (async function checkLogin(){
    try{
      const r = await fetch('/api/me',{credentials:'include'});
      if(!r.ok) return;
      const d = await r.json();
      if(!d.ok || !d.user) return;
      document.querySelectorAll('.btn.login').forEach(b=>b.style.display='none');
      document.querySelectorAll('.btn.logout').forEach(b=>b.style.display='inline-block');
    }catch(e){ console.error(e); }
  })();

  // 최근 문의(가장 최근 채팅방 이름 표시)
  async function loadRecentInbox(){
    const box = document.getElementById('inbox');
    if (!box) return;
    box.textContent = '불러오는 중…';

    try{
      const r = await fetch('/api/agents/me/recent-chat', { credentials:'same-origin' });
      const j = await r.json();

      if (!r.ok || !j.ok) throw new Error('load failed');

      if (!j.room){
        box.innerHTML = `
          <div class="muted">아직 최근 문의가 없습니다.</div>
          <div style="margin-top:8px">
            <button class="btn" onclick="openPopup(event, 'chat.html', '문의함')">문의함 열기</button>
          </div>`;
        return;
      }

      const name = j.room.user_name || '(이름 없음)';
      const when = new Date(j.room.created_at).toLocaleString('ko-KR');

      box.innerHTML = `
        <div style="font-weight:800">${name}</div>
        <div class="muted" style="margin-top:4px">최근 생성: ${when}</div>
        <div style="margin-top:8px">
          <button class="btn" onclick="openPopup(event, 'chat.html?room_id=${encodeURIComponent(j.room.room_id)}', '문의함')">열기</button>
        </div>`;
    }catch(e){
      console.error(e);
      box.textContent = '최근 문의를 불러오지 못했습니다.';
    }
  }

  document.addEventListener('DOMContentLoaded', loadRecentInbox);
  </script>
</main>
</body>
</html>
