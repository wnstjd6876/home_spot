<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>HomeSpot - ì•„íŒŒíŠ¸ ê²€ìƒ‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --panel:#151922; --panel-2:#1a2030; --text:#e7ecf3; --muted:#9aa7b2;
      --accent:#4ea1ff; --accent-2:#2dd4bf; --chip:#22283a; --chip-on:#2b3854; --bd:#2a3142;
    }
    *{ box-sizing: border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Malgun Gothic,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    #app{ display:flex; height:100vh; width:100vw; overflow:hidden; }

    /* ì¢Œì¸¡ íŒ¨ë„ + ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
    #panel{
      width: 26vw; min-width: 320px; max-width: 560px;
      background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border-right:1px solid var(--bd);
      display:flex; flex-direction:column; overflow:hidden;
    }
    #panelScroll{
    flex:1; display:flex; flex-direction:column;  /* ìŠ¤í¬ë¡¤ì€ ë¦¬ìŠ¤íŠ¸ë§Œ */
    overflow:hidden; -webkit-overflow-scrolling:touch;
    padding:12px 12px 0;
    }

    #mapWrap{ flex:1; position:relative; }
    #map{ position:absolute; inset:0; }

    /* ê²€ìƒ‰ë°•ìŠ¤ */
    .search-row{ display:flex; gap:8px; align-items:center; }
    .search-row input[type="text"]{
      flex:1; height:40px; background:#0d111a; color:var(--text);
      border:1px solid var(--bd); border-radius:10px; padding:0 12px; outline:none;
    }
    .btn{
      height:40px; padding:0 12px; border-radius:10px; border:1px solid var(--bd);
      background:#111827; color:var(--text); cursor:pointer; transition:transform .02s ease;
    }
    .btn:active{ transform: translateY(1px); }

    /* ë²„íŠ¼ ê·¸ë£¹ */
    .group{ display:flex; flex-wrap:wrap; gap:6px; }
    .chip{
      padding:8px 12px; border-radius:999px; border:1px solid var(--bd);
      background:var(--chip); color:var(--muted); cursor:pointer; user-select:none; font-size:13px;
    }
    .chip[data-active="1"]{ background:var(--chip-on); color:var(--text); border-color:#3b4966; }
    .chip[data-variant="radio"]{ border-radius:10px; }
    .chip[data-role="feature"]::before{ content:"#"; color:var(--muted); margin-right:3px; }

    /* ì„¹ì…˜(ì ‘ì´ì‹) */
    .sec{ background:rgba(255,255,255,0.02); border:1px solid var(--bd); border-radius:14px; }
    .sec-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 10px 6px; cursor:pointer; user-select:none; }
    .sec-head h3{ margin:0; font-size:14px; color:#c9d3e1; font-weight:600; }
    .chev{ transition:transform .15s ease; opacity:.9; }
    .sec-body{ padding:0 10px 10px; }
    .collapsible[data-collapsed="1"] .sec-body{ display:none; }
    .collapsible[data-collapsed="1"] .chev{ transform:rotate(-90deg); }

    /* ê²°ê³¼ ì˜ì—­(ìš”ì•½ ê³ ì • + ë¦¬ìŠ¤íŠ¸ ìŠ¤í¬ë¡¤) */
    #results{ display:flex; flex-direction:column; gap:0; min-height:0; }
    #resultsScroll{ flex:1; min-height:0; overflow-y:auto; padding-bottom:12px; }
    #resultsScroll::-webkit-scrollbar{ width:10px; }
    #resultsScroll::-webkit-scrollbar-thumb{ background:#1f2738; border-radius:8px; }
    #resultsScroll::-webkit-scrollbar-track{ background:transparent; }

    /* ìš”ì•½/ë¦¬ìŠ¤íŠ¸ */
    #summary{ display:flex; align-items:center; justify-content:space-between; padding:6px 2px 0; }
    #total{ font-weight:700; }
    .card{ border:1px solid var(--bd); border-radius:12px; padding:10px; background:rgba(255,255,255,0.02); display:grid; grid-template-columns:76px 1fr; gap:10px; }
    .card + .card{ margin-top:8px; }
    .thumb{ width:76px; height:76px; border-radius:10px; background:#0a0f18; border:1px solid #1f2740; display:flex; align-items:center; justify-content:center; font-size:12px; color:var(--muted); overflow:hidden; }
    .title{ font-weight:700; margin-bottom:4px; font-size:15px; }
    .meta{ font-size:12px; color:#a9b6c4; display:flex; gap:10px; flex-wrap:wrap; }
    .price{ color:var(--accent-2); font-weight:800; }
    .deal-tag{ padding:2px 6px; border-radius:999px; background:#0e1624; border:1px solid #25314a; font-size:11px; color:#c8d5ff; }
    #more{ margin:8px auto 14px; display:block; width:90%; }

    /* ë§ˆì»¤ ë§í’ì„  */
    .price-pin{ background:#111827ee; border:1px solid #2b3752; color:#e7f2ff; border-radius:10px; padding:4px 8px; font-weight:800; font-size:12px; box-shadow:0 6px 18px rgba(0,0,0,.35); white-space:nowrap; }

    /* ìƒë‹¨ ê³ ì • */
    #filtersSticky{ position:sticky; top:0; z-index:3; background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%); padding-bottom:6px; }
    .sep{ height:8px; }

    /* ë°˜ì‘í˜• */
    @media (max-width:1200px){ #panel{ width:32vw; } }
    @media (max-width:960px){ #panel{ width:40vw; min-width:0; } }
    @media (max-width:780px){
      #app{ flex-direction:column; }
      #panel{ width:100vw; height:50vh; border-right:0; border-bottom:1px solid var(--bd); }
      #mapWrap{ height:50vh; }
    }
    /* â”€â”€â”€ ìƒë‹¨ ì´ë™ ë°” â”€â”€â”€ */
    .topnav{position:sticky;top:0;z-index:10;
      display:flex;align-items:center;gap:8px;
      padding:8px 12px;border-bottom:1px solid #2b3752;
      background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);
    }
    .topnav .brand{font-weight:800;letter-spacing:.2px;cursor:pointer}
    .topnav nav{display:flex;flex-wrap:wrap;gap:6px}
    .topnav a{display:inline-flex;align-items:center;height:34px;padding:0 12px;
      border-radius:999px;border:1px solid var(--bd);
      background:#111827;color:var(--text);text-decoration:none;font-size:13px;white-space:nowrap;
    }
    .topnav a:hover{border-color:#3b4966}
    .topnav a.active{background:var(--chip-on);border-color:#3b4966;
      box-shadow:0 0 0 2px rgba(46,115,255,.15) inset}

  </style>
</head>
<body>
  <header class="topnav" role="navigation" aria-label="ìƒë‹¨ ì´ë™ ë©”ë‰´">
  <div class="brand" onclick="location.href='tenant_main.html'">ğŸ  í™ˆìŠ¤íŒŸ</div>
  <nav>
    <a href="search_apartment.html"   data-match="search_apartment.html">ì•„íŒŒíŠ¸</a>
    <a href="search_officetel.html"   data-match="search_officetel.html">ì˜¤í”¼ìŠ¤í…”</a>
    <a href="search_rowhouse.html"    data-match="search_rowhouse.html">ì—°ë¦½Â·ë‹¤ì„¸ëŒ€</a>
    <a href="search_detached.html"    data-match="search_detached.html">ë‹¨ë…ì£¼íƒ</a>
    <a href="all_listings.html"       data-match="all_listings.html">ì „ì²´</a>
  </nav>
</header>

<div id="app">
  <!-- ì¢Œì¸¡ íŒ¨ë„ -->
  <aside id="panel">
    <div id="panelScroll">
      <div id="filtersSticky">
        <div class="search-row">
          <input id="q" type="text" placeholder="ì§€ì—­/ë„ë¡œëª…/í‚¤ì›Œë“œ ê²€ìƒ‰â€¦" />
          <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
        </div>

        <div class="sep"></div>


        <div class="sep"></div>

        <!-- ê±°ë˜ ìœ í˜• -->
        <div class="sec collapsible" data-collapsed="0">
          <div class="sec-head" tabindex="0" aria-expanded="true"><h3>ê±°ë˜ ìœ í˜•</h3><span class="chev">â–¾</span></div>
          <div class="sec-body">
            <div id="grpDeal" class="group" data-mode="radio">
              <span class="chip" data-variant="radio" data-key="deal" data-value="">ì „ì²´</span>
              <span class="chip" data-variant="radio" data-key="deal" data-value="sale">ë§¤ë§¤</span>
              <span class="chip" data-variant="radio" data-key="deal" data-value="jeonse">ì „ì„¸</span>
              <span class="chip" data-variant="radio" data-key="deal" data-value="monthly">ì›”ì„¸</span>
              <span class="chip" data-variant="radio" data-key="deal" data-value="presale_right">ë¶„ì–‘ê¶Œ</span>
              <span class="chip" data-variant="radio" data-key="deal" data-value="occupancy_right">ì…ì£¼ê¶Œ</span>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <!-- ê°€ê²© -->
        <div class="sec collapsible" data-collapsed="0">
          <div class="sec-head" tabindex="0" aria-expanded="true"><h3>ê°€ê²© (10,000ì› ë‹¨ìœ„)</h3><span class="chev">â–¾</span></div>
          <div class="sec-body">
            <div id="grpPrice" class="group" data-mode="range">
              <span class="chip" data-role="price" data-min="" data-max="">ì „ì²´</span>
              <span class="chip" data-role="price" data-min="0" data-max="20000">~ 2ì–µ</span>
              <span class="chip" data-role="price" data-min="20000" data-max="40000">2ì–µ ~ 4ì–µ</span>
              <span class="chip" data-role="price" data-min="40000" data-max="60000">4ì–µ ~ 6ì–µ</span>
              <span class="chip" data-role="price" data-min="60000" data-max="">6ì–µ+</span>
              <span class="chip" id="btnPriceCustom">ì§ì ‘ì…ë ¥</span>
            </div>
            <div id="priceCustomBox" class="group" style="margin-top:8px; display:none;">
              <input id="minPrice" type="number" inputmode="numeric" placeholder="ìµœì†Œ(ì˜ˆ: 20000)" class="btn" style="width:48%;" />
              <input id="maxPrice" type="number" inputmode="numeric" placeholder="ìµœëŒ€(ì˜ˆ: 60000)" class="btn" style="width:48%;" />
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <!-- ë©´ì  -->
        <div class="sec collapsible" data-collapsed="0">
          <div class="sec-head" tabindex="0" aria-expanded="true"><h3>ì „ìš©/ê³µê¸‰ ë©´ì  (mÂ²)</h3><span class="chev">â–¾</span></div>
          <div class="sec-body">
            <div id="grpArea" class="group" data-mode="range">
              <span class="chip" data-role="area" data-min="" data-max="">ì „ì²´</span>
              <span class="chip" data-role="area" data-min="0" data-max="33">~ 33</span>
              <span class="chip" data-role="area" data-min="33" data-max="66">33 ~ 66</span>
              <span class="chip" data-role="area" data-min="66" data-max="99">66 ~ 99</span>
              <span class="chip" data-role="area" data-min="99" data-max="">99+</span>
              <span class="chip" id="btnAreaCustom">ì§ì ‘ì…ë ¥</span>
            </div>
            <div id="areaCustomBox" class="group" style="margin-top:8px; display:none;">
              <input id="minArea" type="number" inputmode="numeric" placeholder="ìµœì†Œ mÂ²" class="btn" style="width:48%;" />
              <input id="maxArea" type="number" inputmode="numeric" placeholder="ìµœëŒ€ mÂ²" class="btn" style="width:48%;" />
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <!-- íŠ¹ì§• -->
        <div class="sec collapsible" data-collapsed="0">
          <div class="sec-head" tabindex="0" aria-expanded="true"><h3>íŠ¹ì§•</h3><span class="chev">â–¾</span></div>
          <div class="sec-body">
            <div id="grpFeature" class="group" data-mode="multi">
              <span class="chip" data-role="feature" data-key="has_parking">ì£¼ì°¨</span>
              <span class="chip" data-role="feature" data-key="allow_pet">ë°˜ë ¤ë™ë¬¼</span>
              <span class="chip" data-role="feature" data-key="is_full_option">í’€ì˜µì…˜</span>
              <span class="chip" data-role="feature" data-key="has_veranda">ë² ë€ë‹¤</span>
              <span class="chip" data-role="feature" data-key="has_garden">ë§ˆë‹¹</span>
              <span class="chip" data-role="feature" data-key="is_new_build">ì‹ ì¶•</span>
              <span class="chip" data-role="feature" data-key="fee_included">ê´€ë¦¬ë¹„í¬í•¨</span>
            </div>
          </div>
        </div>
      </div><!-- /filtersSticky -->

      <div id="results">
     <!-- ìš”ì•½(ê³ ì •) -->
     <div id="summary">
       <div id="total">ì´ 0ê°œ</div>
       <div id="viewMeta" style="color:var(--muted); font-size:12px;">ë·°í¬íŠ¸ ê¸°ì¤€</div>
     </div>
     <!-- ë¦¬ìŠ¤íŠ¸ë§Œ ìŠ¤í¬ë¡¤ -->
     <div id="resultsScroll">
       <div id="list"></div>
       <button id="more" class="btn">ë” ë³´ê¸°</button>
     </div>
   </div>
  </aside>

  <!-- ìš°ì¸¡ ì§€ë„ -->
  <main id="mapWrap"><div id="map"></div></main>
</div>

<!-- Kakao Map -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5970bdf6aec828dc6aa07626ba3794cf&autoload=false&libraries=clusterer"></script>

<script>
  // ì „ì—­ ìƒíƒœ
  let map, clusterer, hoverOverlay=null, hoverEl=null;
  let isLoading=false, inflight=null, currentPage=1, lastRectKey='', lastQueryKey='';
   const selected = {
    type: new Set(['apartment']), // í•­ìƒ ì•„íŒŒíŠ¸ë§Œ
     deal: '',
     minPrice: '', maxPrice: '',
     minArea: '',  maxArea:  '',
     has_parking:false, allow_pet:false, is_full_option:false, has_veranda:false,
     has_garden:false, is_new_build:false, fee_included:false,
   };

  // ìœ í‹¸
  const money10k = (n)=>{ if(n==null||isNaN(n))return'-'; const won = Number(n)*10000; const eok=Math.floor(won/1e8); const man=Math.floor((won%1e8)/1e4);
    if(eok>0&&man>0) return `${eok}ì–µ ${man.toLocaleString()}ë§Œ`; if(eok>0) return `${eok}ì–µ`; return `${man.toLocaleString()}ë§Œ`; };
  const debounce=(fn,ms=300)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
  function getRect(){ const b=map.getBounds(), sw=b.getSouthWest(), ne=b.getNorthEast(); return [sw.getLng(), sw.getLat(), ne.getLng(), ne.getLat()]; }
  function ensureOverlay(){ if(hoverOverlay) return; hoverEl=document.createElement('div'); hoverEl.className='price-pin';
    hoverOverlay=new kakao.maps.CustomOverlay({content:hoverEl, position: map.getCenter(), yAnchor:1}); }
  function setSummary(t){ document.getElementById('total').textContent=`ì´ ${Number(t||0).toLocaleString('ko-KR')}ê°œ`; }

  // ì ‘ì´ì‹ ì´ˆê¸°í™”
  function initCollapsibles(){
    document.querySelectorAll('.collapsible .sec-head').forEach(head=>{
      head.addEventListener('click',()=>{ const sec=head.parentElement; const on=sec.dataset.collapsed!=='1'; sec.dataset.collapsed= on?'1':'0'; head.setAttribute('aria-expanded', (!on).toString()); });
      head.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); head.click(); } });
    });
  }

  // í•„í„° ë²„íŠ¼
  function bindFilterChips(){
    // ìœ í˜•(ë‹¤ì¤‘)
    document.getElementById('grpType')?.addEventListener('click', (e)=>{
      const chip=e.target.closest('.chip'); if(!chip||chip.dataset.key!=='type') return;
      const v=chip.dataset.value; if(chip.dataset.active==='1'){chip.dataset.active='0';selected.type.delete(v);} else {chip.dataset.active='1';selected.type.add(v);} forceReload();
    });
    // ê±°ë˜(ë¼ë””ì˜¤)
    document.getElementById('grpDeal')?.addEventListener('click', (e)=>{
      const chip=e.target.closest('.chip'); if(!chip||chip.dataset.key!=='deal') return;
      [...e.currentTarget.querySelectorAll('.chip')].forEach(c=>c.dataset.active='0'); chip.dataset.active='1'; selected.deal=chip.dataset.value||''; forceReload();
    });
    document.querySelector('#grpDeal .chip[data-value=""]')?.setAttribute('data-active','1');

    // ê°€ê²© í”„ë¦¬ì…‹/ì§ì ‘
    const grpPrice=document.getElementById('grpPrice');
    grpPrice?.addEventListener('click',(e)=>{
      const chip=e.target.closest('.chip'); if(!chip) return;
      if(chip.id==='btnPriceCustom'){ document.getElementById('priceCustomBox').style.display='flex'; chip.dataset.active = chip.dataset.active==='1'?'0':'1'; return; }
      if(chip.dataset.role!=='price') return;
      grpPrice.querySelectorAll('.chip[data-role="price"]').forEach(c=>c.dataset.active='0'); chip.dataset.active='1';
      selected.minPrice=chip.dataset.min??''; selected.maxPrice=chip.dataset.max??'';
      document.getElementById('priceCustomBox').style.display='none'; document.getElementById('minPrice').value=''; document.getElementById('maxPrice').value='';
      forceReload();
    });
    ['minPrice','maxPrice'].forEach(id=>document.getElementById(id).addEventListener('change',()=>{
      selected.minPrice=document.getElementById('minPrice').value.trim(); selected.maxPrice=document.getElementById('maxPrice').value.trim();
      document.querySelectorAll('#grpPrice .chip[data-role="price"]').forEach(c=>c.dataset.active='0'); forceReload();
    }));

    // ë©´ì  í”„ë¦¬ì…‹/ì§ì ‘
    const grpArea=document.getElementById('grpArea');
    grpArea?.addEventListener('click',(e)=>{
      const chip=e.target.closest('.chip'); if(!chip) return;
      if(chip.id==='btnAreaCustom'){ document.getElementById('areaCustomBox').style.display='flex'; chip.dataset.active = chip.dataset.active==='1'?'0':'1'; return; }
      if(chip.dataset.role!=='area') return;
      grpArea.querySelectorAll('.chip[data-role="area"]').forEach(c=>c.dataset.active='0'); chip.dataset.active='1';
      selected.minArea=chip.dataset.min??''; selected.maxArea=chip.dataset.max??'';
      document.getElementById('areaCustomBox').style.display='none'; document.getElementById('minArea').value=''; document.getElementById('maxArea').value='';
      forceReload();
    });
    ['minArea','maxArea'].forEach(id=>document.getElementById(id).addEventListener('change',()=>{
      selected.minArea=document.getElementById('minArea').value.trim(); selected.maxArea=document.getElementById('maxArea').value.trim();
      document.querySelectorAll('#grpArea .chip[data-role="area"]').forEach(c=>c.dataset.active='0'); forceReload();
    }));

    // íŠ¹ì§•(ë‹¤ì¤‘)
    document.getElementById('grpFeature')?.addEventListener('click',(e)=>{
      const chip=e.target.closest('.chip'); if(!chip||chip.dataset.role!=='feature') return;
      const k=chip.dataset.key; selected[k]=!selected[k]; chip.dataset.active= selected[k]?'1':'0'; forceReload();
    });

    // í‚¤ì›Œë“œ
    document.getElementById('btnSearch').addEventListener('click',()=>forceReload());
    document.getElementById('q').addEventListener('keydown',e=>{ if(e.key==='Enter') forceReload(); });
  }

  function forceReload(){ loadPage(1,{force:true}); }

  // ë¦¬ìŠ¤íŠ¸/ë§ˆì»¤ ë Œë”
  function renderList(j,opt={}){
    const wrap=document.getElementById('list'); if(!opt.append) wrap.innerHTML='';
    (j.list||[]).forEach(it=>{
      const li=document.createElement('div'); li.className='card';
      const t=document.createElement('div'); t.className='thumb'; t.textContent='NO IMG';
      if(it.thumb_url){ t.textContent=''; const img=new Image(); img.src=it.thumb_url; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; t.appendChild(img); }
      const r=document.createElement('div');
      const ttl=document.createElement('div'); ttl.className='title'; ttl.textContent = it.title || `${(it.sigungu||'')+' '+(it.road_name||it.lot_no||'')}`;
      const meta=document.createElement('div'); meta.className='meta';
      const price=document.createElement('div'); price.className='price';
      price.textContent = money10k(
        it.price_key_10k ?? it.price_10k ?? it.price_sale_10k ?? it.deposit_10k ?? it.rent_10k
      );
      const deal=document.createElement('div'); deal.className='deal-tag'; deal.textContent=(it.deal_type||'').toUpperCase();
      meta.append(price,deal); if(it.area_m2){ const a=document.createElement('div'); a.textContent=`${it.area_m2}mÂ²`; meta.appendChild(a); }
      if(it.built_year){ const by=document.createElement('div'); by.textContent=`ì¤€ê³µ ${it.built_year}`; meta.appendChild(by); }
      r.append(ttl,meta); li.append(t,r);
      li.addEventListener('click', ()=> openDetail(it.listing_id));
      wrap.appendChild(li);
    });
    const moreBtn=document.getElementById('more');
    const hasMore = ('hasMore' in j) ? !!j.hasMore
                 : ((j.list||[]).length >= (j.pageSize||20)); // fallback
    if (hasMore){
      moreBtn.style.display='block';
      moreBtn.disabled = false;
      moreBtn.textContent = 'ë” ë³´ê¸°';
      moreBtn.onclick = async ()=>{
        moreBtn.disabled = true; moreBtn.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
        await loadPage((j.page||1)+1, { append:true, force:true, listOnly:true });
      };
    }else{
      moreBtn.style.display='none';
      moreBtn.onclick = null;
    }
  }

  function renderMarkers(j){
    ensureOverlay();
    if(!clusterer){
      clusterer=new kakao.maps.MarkerClusterer({
        map, averageCenter:true, minLevel:6, gridSize:80, disableClickZoom:true,
        calculator:[10,30,70,150],
        styles:[
          {width:'28px',height:'28px',lineHeight:'28px',background:'rgba(17,24,39,.92)',color:'#fff',textAlign:'center',borderRadius:'9999px',border:'1.5px solid #2b3752',fontWeight:'800',fontSize:'12px'},
          {width:'36px',height:'36px',lineHeight:'36px',background:'rgba(17,24,39,.92)',color:'#fff',textAlign:'center',borderRadius:'9999px',border:'2px solid #3c5a9a',fontWeight:'800',fontSize:'13px'},
          {width:'44px',height:'44px',lineHeight:'44px',background:'rgba(17,24,39,.94)',color:'#fff',textAlign:'center',borderRadius:'9999px',border:'2px solid #5ea3ff',fontWeight:'900',fontSize:'14px'},
          {width:'52px',height:'52px',lineHeight:'52px',background:'rgba(15,23,42,.96)',color:'#fff',textAlign:'center',borderRadius:'9999px',border:'2px solid #22d3ee',fontWeight:'900',fontSize:'15px'},
          {width:'60px',height:'60px',lineHeight:'60px',background:'rgba(2,6,23,.98)', color:'#fff',textAlign:'center',borderRadius:'9999px',border:'3px solid #34d399',fontWeight:'900',fontSize:'16px'},
        ]
      });
      kakao.maps.event.addListener(clusterer,'clusterclick',cluster=>{ const lv=map.getLevel(); map.setLevel(Math.max(lv-2,1),{anchor:cluster.getCenter()}); });
    }
    clusterer.clear();
    const markers=(j.markers||[]).map(m=>{
      const mk=new kakao.maps.Marker({ position:new kakao.maps.LatLng(m.lat,m.lng) });
      const label=document.createElement('div'); label.className='price-pin';
      label.textContent = money10k(m.price_key_10k ?? m.price_10k ?? m.price)
      const ov=new kakao.maps.CustomOverlay({ content:label, position:mk.getPosition(), yAnchor:1 });
      kakao.maps.event.addListener(mk,'mouseover',()=>{ hoverOverlay.setPosition(mk.getPosition()); hoverEl.textContent=label.textContent; hoverOverlay.setMap(map); });
      kakao.maps.event.addListener(mk,'mouseout', ()=>{ hoverOverlay.setMap(null); });
      kakao.maps.event.addListener(mk,'click',   ()=> openDetail(m.listing_id));
      return mk;
    });
    clusterer.addMarkers(markers);
  }

  // ì„œë²„ í˜¸ì¶œ
  async function loadPage(page=1,opt={}){
    if(isLoading && inflight){ try{ inflight.abort(); }catch{} }
    isLoading=true; inflight=new AbortController();
    const rect=getRect(), rectKey=rect.map(n=>Number(n).toFixed(5)).join(','), z=map.getLevel();
    if(!opt.force && page===currentPage && rectKey===lastRectKey){ isLoading=false; return; }

    const qs=new URLSearchParams({ rect:rect.join(','), page:String(page), z:String(z) });
    if (opt.listOnly) qs.set('list_only','1');
    //ë‚˜ì¤‘ì— ì§€ìš¸ë¶€ë¶„ (if (opt.listOnly) qs.set('debug','1');)
    if (opt.listOnly) qs.set('debug','1');

    const qStr=document.getElementById('q').value.trim(); if(qStr) qs.set('q',qStr);
    if (selected.type && selected.type.size) {
      qs.set('type', Array.from(selected.type).join(','));
    }
    if(selected.deal) qs.set('deal',selected.deal);
    const addNum=(k,v)=>{ const n=Number(v); if(Number.isFinite(n)&&n>=0) qs.set(k,String(n)); };
    addNum('minPrice',selected.minPrice); addNum('maxPrice',selected.maxPrice);
    addNum('minArea',selected.minArea); addNum('maxArea',selected.maxArea);
    ['has_parking','allow_pet','is_full_option','has_veranda','has_garden','is_new_build','fee_included'].forEach(k=>{ if(selected[k]) qs.set(k,'1'); });
    const queryKey=qs.toString(); if(!opt.append && queryKey===lastQueryKey && rectKey===lastRectKey){ isLoading=false; return; }

    try{
      const res=await fetch(`/api/map/listings?${qs.toString()}`,{signal:inflight.signal});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const j=await res.json();
      currentPage=page; lastRectKey=rectKey; lastQueryKey=queryKey;
      if (!opt.listOnly) renderMarkers(j); renderList(j,{append:!!opt.append});
      if (!opt.listOnly && typeof j.total==='number') setSummary(j.total);
    }catch(err){
      console.error('[map/listings] error', err);
      const moreBtn = document.getElementById('more');
      if (moreBtn) { moreBtn.disabled = false; moreBtn.textContent = 'ë” ë³´ê¸°'; }
    }
    finally{ isLoading=false; }
  }

  // ìƒì„¸ë¡œ ì´ë™
  function openDetail(listingId){
    if(!listingId) return;
    location.href = `listing_detail.html?id=${encodeURIComponent(listingId)}`;
  }

  // ì§€ë„ ì´ˆê¸°í™”
  kakao.maps.load(function(){
    const center=new kakao.maps.LatLng(37.566535,126.9779692);
    map=new kakao.maps.Map(document.getElementById('map'),{ center, level:6 });
    kakao.maps.event.addListener(map,'idle',debounce(()=>loadPage(1),350));

    initCollapsibles();
    bindFilterChips();
    loadPage(1,{force:true});
  });
  (function(){
  var file = location.pathname.split('/').pop();
  document.querySelectorAll('.topnav a').forEach(function(a){
    var m = a.getAttribute('data-match') || a.getAttribute('href');
    if(m === file) a.classList.add('active');
  });
})();
</script>
</body>
</html>
