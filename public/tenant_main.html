<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í™ˆìŠ¤íŒŸ â€“ ì„¸ì…ì</title>
  <style>
    :root {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --line: #e6e8ee;
      --text: #0f172a;
      --muted: #6b7280;
      --shadow: 0 10px 30px rgba(17, 24, 39, 0.06);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 15px/1.55 ui-sans-serif, system-ui, "Noto Sans KR", sans-serif;
    }
    a { color: inherit; text-decoration: none; }
    header { position: sticky; top: 0; z-index: 20; background: #fff; border-bottom: 1px solid var(--line); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px 24px; }
    .row { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; }
    .logo { width: 28px; height: 28px; border-radius: 8px; background: linear-gradient(135deg, #2563eb, #8b5cf6); }
    .right { margin-left: auto; display: flex; gap: 10px; }
    .btn {
      padding: 10px 14px; border: 1px solid var(--line); border-radius: 12px;
      background: #fff; cursor: pointer;
    }
    .btn.primary { background: #2563eb; color: #fff; border-color: transparent; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,0.08); }

    .hero {
      margin-top: 18px; border-radius: 20px; padding: 28px;
      background: radial-gradient(900px 350px at 15% -50%, #dbeafe 10%, transparent 60%),
                  linear-gradient(135deg, #eff6ff, #f5f3ff);
      border: 1px solid var(--line); box-shadow: var(--shadow);
    }
    .hero h1 { margin: 0 0 8px; font-size: 26px; }

    .search {
      display: flex; gap: 10px; align-items: center;
      background: #fff; border: 1px solid var(--line); border-radius: 999px;
      padding: 10px 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.03); width: 100%;
    }
    .search select {
      border: 1px solid var(--line); border-radius: 999px;
      padding: 8px 10px; background: #fff; outline: 0;
    }
    .search input { border: 0; outline: 0; flex-grow: 1; font-size: 16px; background: transparent; padding: 6px 4px; }
    .search button { margin-left: auto; }

    .filterbar { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
    .chip { border: 1px solid var(--line); background: #fff; border-radius: 999px; padding: 8px 12px; cursor: pointer; }
    .chip.active { background: #eef2ff; border-color: #c7d2fe; }

    .section-title { display: flex; align-items: center; justify-content: space-between; margin-top: 20px; }
    .grid { display: grid; gap: 16px; }
    .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width: 1024px) { .grid-3 { grid-template-columns: 1fr; } }

    .card {
      background: #fff; border: 1px solid var(--line); border-radius: 16px;
      padding: 18px; box-shadow: var(--shadow); position: relative; overflow: hidden;
    }
    .card .desc { opacity: 0.85; }
    .thumb {
      position: absolute; right: 16px; bottom: 16px;
      width: 70px; height: 70px; border-radius: 14px;
      background: rgba(255,255,255,0.25); display: grid; place-items: center; font-size: 28px;
    }

    .cat { color: #fff; }
    .cat.house     { background: linear-gradient(135deg, #60a5fa, #3b82f6); }
    .cat.apartment { background: linear-gradient(135deg, #f87171, #ef4444); }
    .cat.office    { background: linear-gradient(135deg, #34d399, #059669); }
    .cat.rowhouse  { background: linear-gradient(135deg, #22d3ee, #06b6d4); }
    .cat.detached  { background: linear-gradient(135deg, #a3e635, #84cc16); }
    .cat.sale      { background: linear-gradient(135deg, #a78bfa, #7c3aed); }
    .cat.allsearch    { background: linear-gradient(135deg, #f472b6, #ec4899); }
    .cat.favorites { background: linear-gradient(135deg, #fb7185, #f59e0b); }

    .placeholder { padding: 14px; border: 1px dashed var(--line); border-radius: 12px; background: #fff; color: #6b7280; text-align: center; }
    .favbar { display: flex; gap: 10px; overflow: auto; }
    .fav { min-width: 220px; background: #fff; border: 1px solid var(--line); border-radius: 12px; padding: 12px; }
  </style>
</head>
<body>

<header>
  <div class="wrap row">
    <div class="brand">
      <div class="logo"></div>
      í™ˆìŠ¤íŒŸ
    </div>
    <nav class="right">
      <a class="btn" href="tenant_favorites.html">ê´€ì‹¬ëª©ë¡</a>

      <!-- ë¹„ë¡œê·¸ì¸ì¼ ë•Œ -->
      <a class="btn" id="btnLogin" href="login.html">ë¡œê·¸ì¸</a>
      <a class="btn primary" id="btnSignup" href="tenant_signup.html">íšŒì›ê°€ì…</a>

      <!-- ë¡œê·¸ì¸ í›„ ë³´ì´ê²Œ -->
      <a class="btn" id="btnProfile" href="profile_setting.html" style="display:none">í”„ë¡œí•„</a>
      <a class="btn" id="btnLogout" href="/logout" style="display:none">ë¡œê·¸ì•„ì›ƒ</a>
    </nav>
  </div>
</header>

<main class="wrap">

  <section class="hero">
    <h1>ì¡°ê±´ ë§ëŠ” ì§‘, ë¹ ë¥´ê²Œ ì°¾ì ğŸ§­</h1>

    <!-- ê²€ìƒ‰ ë°”: ìœ í˜• ë“œë¡­ë‹¤ìš´ + ê²€ìƒ‰ì–´ + ë²„íŠ¼ -->
    <div class="search">
      <label for="ptype" style="font-size:12px; color:#64748b;">ìœ í˜•</label>
      <select id="ptype" aria-label="ë§¤ë¬¼ ìœ í˜• ì„ íƒ">
        <option value="all">ì „ì²´</option> 
        <option value="apartment">ì•„íŒŒíŠ¸</option>
        <option value="officetel">ì˜¤í”¼ìŠ¤í…”</option>
        <option value="rowhouse">ì—°ë¦½Â·ë‹¤ì„¸ëŒ€</option>
        <option value="detached">ë‹¨ë…ì£¼íƒ</option>
      </select>
      <input id="q" placeholder="ì§€ì—­ Â· ì§€í•˜ì² ì—­ Â· í‚¤ì›Œë“œë¡œ ê²€ìƒ‰" />
      <button class="btn" onclick="goSearch()">ê²€ìƒ‰</button>
    </div>
    <section id="results" class="section" style="margin-top:16px; display:none">
      <div class="section-title" style="display:flex;align-items:center;gap:8px">
        <h3 style="margin:0">ê²€ìƒ‰ ê²°ê³¼</h3>
        <span id="resultCount" class="tag">0ê±´</span>
      </div>
      <div id="resultGrid" style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;"></div>
      <div id="pager" style="display:flex;gap:8px;justify-content:center;margin-top:10px;"></div>
    </section>
  </section>

  <!-- ì¹´í…Œê³ ë¦¬ ì¹´ë“œ -->
  <section class="grid grid-3" style="margin-top:16px">
    <a class="card cat apartment" href="search_apartment.html">
      <h3>ì•„íŒŒíŠ¸</h3>
      <div class="desc">ë‹¨ì§€ ì •ë³´ Â· ì‹¤ê±°ë˜ê°€ ì•Œë¦¼</div>
      <div class="thumb">ğŸ¢</div>
    </a>

    <a class="card cat office" href="search_officetel.html">
      <h3>ì˜¤í”¼ìŠ¤í…”</h3>
      <div class="desc">ë‹¤ì–‘í•œ ì˜µì…˜ê³¼ í•©ë¦¬ì  ì „ì›”ì„¸</div>
      <div class="thumb">ğŸ™ï¸</div>
    </a>

    <a class="card cat rowhouse" href="search_rowhouse.html">
      <h3>ì—°ë¦½Â·ë‹¤ì„¸ëŒ€</h3>
      <div class="desc">ì‹¤ì† ìˆëŠ” ì£¼ê±° ì„ íƒì§€</div>
      <div class="thumb">ğŸ˜ï¸</div>
    </a>

    <a class="card cat detached" href="search_detached.html">
      <h3>ë‹¨ë…ì£¼íƒ</h3>
      <div class="desc">ë§ˆë‹¹/ì£¼ì°¨ ë“± ë¼ì´í”„ìŠ¤íƒ€ì¼ë³„ ì„ íƒ</div>
      <div class="thumb">ğŸ </div>
    </a>

    <a class="card cat allsearch" href="all_listings.html">
          <h3>ì „ì²´ ë§¤ë¬¼</h3>
          <div class="desc">ëª¨ë“  ë§¤ë¬¼ ëª¨ì•„ë³´ê¸°</div>
          <div class="thumb" aria-hidden="true">â¤</div>
        </a>

    <a class="card cat favorites" href="tenant_favorites.html">
      <h3>ë‚´ ì°œëª©ë¡</h3>
      <div class="desc">ì €ì¥í•œ ë§¤ë¬¼ ëª¨ì•„ë³´ê¸°</div>
      <div class="thumb" aria-hidden="true">â¤</div>
    </a>

    
  </section>

  <!--  ì¶”ì²œ ë§¤ë¬¼ -->
  <div class="section-title" style="margin-top:20px; margin-bottom:12px; display:flex; align-items:center; gap:8px;">
    <h2 style="margin:0">ì¶”ì²œ ë§¤ë¬¼</h2>
    <div id="recoButtons" style="display:flex; gap:6px; flex-wrap:wrap;"></div>
  </div>
  <div id="recoGrid" style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;"></div>
  <div id="recoMsg" class="placeholder" style="display:none;margin-top:8px;">ì¶”ì²œì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

</main>

<script>
  // ìƒíƒœ ì €ì¥ (í˜ì´ì§•ì— í•„ìš”)
  const __searchState = { type:'all', q:'', page:1, pageSize:12 };

  const $ = (s)=>document.querySelector(s);
  function imgURL(u){
    if(!u) return 'https://picsum.photos/seed/placeholder/400/260';
    if(/^https?:\/\//i.test(u) || /^data:/i.test(u) || u.startsWith('/uploads/')) return u;
    return '/uploads/'+u.replace(/^\/+/, '');
  }
  function money10kToKRW(n){
    if(n==null || isNaN(n)) return '';
    n = Number(n);
    const eok = Math.floor(n / 10000);
    const man = n % 10000;
    if (eok>0 && man>0) return `${eok}ì–µ ${man.toLocaleString()}ë§Œ`;
    if (eok>0) return `${eok}ì–µ`;
    return `${man.toLocaleString()}ë§Œ`;
  }
  function priceLabel(l){
    if(l.deal_type==='sale'   && l.price_sale_10k!=null) return `ë§¤ë§¤ ${money10kToKRW(l.price_sale_10k)}`;
    if(l.deal_type==='jeonse' && l.deposit_10k!=null)    return `ì „ì„¸ ${money10kToKRW(l.deposit_10k)}`;
    if(l.deal_type==='monthly'){
      const dep = l.deposit_10k!=null ? money10kToKRW(l.deposit_10k) : null;
      const rent= l.rent_10k!=null    ? money10kToKRW(l.rent_10k)    : null;
      if(dep && rent) return `ì›”ì„¸ ${dep} / ${rent}`;
      if(rent) return `ì›”ì„¸ ${rent}`;
      if(dep)  return `ë³´ì¦ê¸ˆ ${dep}`;
    }
    if(l.deal_type==='yearly' && l.rent_annual_10k!=null) return `ì—°ì„¸ ${money10kToKRW(l.rent_annual_10k)}`;
    return '';
  }

  // ë©”ì¸: ê²€ìƒ‰ ì‹¤í–‰ (ì´ë™ X)
  async function goSearch(page=1){
    const typeSel = document.getElementById('ptype');
    const input   = document.getElementById('q');

    const type = (typeSel?.value || 'all');
    const q    = (input?.value || '').trim();

    const params = new URLSearchParams({
      type, q, page:String(page), pageSize:'12'
    });

    const res = await fetch('/api/listings/search?' + params.toString());
    const j = await res.json();
    if (!j.ok) { alert('ê²€ìƒ‰ ì‹¤íŒ¨'); return; }

    const box   = document.getElementById('results');
    const grid  = document.getElementById('resultGrid');
    const tag   = document.getElementById('resultCount');
    const pager = document.getElementById('pager');

    // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ì¢…ë£Œ (ê°œë°œ ì¤‘ ì•ˆì •ì„±)
    if (!box || !grid || !tag || !pager) {
      console.warn('[goSearch] results container not found');
      return;
    }

    box.style.display = '';
    tag.textContent = `${j.total}ê±´`;

    const money10k = (n)=>{
      if(n==null || isNaN(n)) return '';
      n = Number(n);
      const eok = Math.floor(n/10000), man = n%10000;
      if(eok>0 && man>0) return `${eok}ì–µ ${man.toLocaleString()}ë§Œ`;
      if(eok>0) return `${eok}ì–µ`;
      return `${man.toLocaleString()}ë§Œ`;
    };
    const priceLabel = (l)=>{
      if(l.deal_type==='sale'   && l.price_sale_10k!=null) return `ë§¤ë§¤ ${money10k(l.price_sale_10k)}`;
      if(l.deal_type==='jeonse' && l.deposit_10k!=null)    return `ì „ì„¸ ${money10k(l.deposit_10k)}`;
      if(l.deal_type==='monthly'){
        const dep=l.deposit_10k!=null?money10k(l.deposit_10k):null;
        const rent=l.rent_10k!=null?money10k(l.rent_10k):null;
        if(dep&&rent) return `ì›”ì„¸ ${dep} / ${rent}`;
        if(rent) return `ì›”ì„¸ ${rent}`;
        if(dep)  return `ë³´ì¦ê¸ˆ ${dep}`;
      }
      if(l.deal_type==='yearly' && l.rent_annual_10k!=null) return `ì—°ì„¸ ${money10k(l.rent_annual_10k)}`;
      return '';
    };
    const imgURL = (u)=>{
      if(!u) return 'https://picsum.photos/seed/placeholder/400/260';
      if(/^https?:\/\//i.test(u) || /^data:/i.test(u) || u.startsWith('/uploads/')) return u;
      return '/uploads/'+u.replace(/^\/+/, '');
    };

    grid.innerHTML = j.items.map(l => `
      <div class="card" style="border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;background:#fff">
        <div style="aspect-ratio:4/2.6;overflow:hidden;background:#f1f5f9">
          <img src="${imgURL(l.cover_image_url)}" alt="" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div style="padding:10px">
          <div style="font-weight:800;margin-bottom:4px">${l.title || '(ì œëª©ì—†ìŒ)'}</div>
          <div style="color:#475569;font-size:13px;margin-bottom:6px">
            ${(l.sigungu||'')} ${(l.road_name||'')} ${(l.lot_no||'')}
          </div>
          <div style="font-weight:900">${priceLabel(l)}</div>
          <button class="btn" style="margin-top:8px;width:100%"
            onclick="location.href='/listing_detail.html?id=${l.listing_id}'">ìƒì„¸ë³´ê¸°</button>
        </div>
      </div>
    `).join('');

    const last = Math.max(1, Math.ceil(j.total / j.pageSize));
    const cur  = j.page;
    const btn = (p, label, disabled)=> `<button class="btn" ${disabled?'disabled':''} onclick="goSearch(${p})">${label}</button>`;
    let html = '';
    html += btn(Math.max(1,cur-1), 'ì´ì „', cur<=1);
    for(let p=Math.max(1,cur-2); p<=Math.min(last,cur+2); p++){
      html += btn(p, String(p), p===cur);
    }
    html += btn(Math.min(last,cur+1), 'ë‹¤ìŒ', cur>=last);
    pager.innerHTML = html;
  }

  // Enter í‚¤ë¡œë„ ê²€ìƒ‰
  document.getElementById('q')?.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') goSearch(1);
  });

  async function loadRecommendations(basisId){
  const box = document.getElementById('recoGrid');
  const msg = document.getElementById('recoMsg');
  msg.style.display = '';
  msg.textContent = 'ì¶”ì²œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

  try {
    const url = basisId
      ? `/api/recommendations/near-favorites?basis=${basisId}`
      : `/api/recommendations/near-favorites`;
    const res = await fetch(url);
    if (res.status===401) {
      msg.textContent = 'ë¡œê·¸ì¸ í›„ ì¶”ì²œì„ ë³¼ ìˆ˜ ìˆì–´ìš”.';
      return;
    }
    const j = await res.json();
    if (!j.ok || !j.items) {
      msg.textContent = 'ì¶”ì²œ ì—†ìŒ';
      return;
    }

    const html = j.items.map(l => `
      <div class="card" style="border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;background:#fff">
        <div style="aspect-ratio:4/2.6;overflow:hidden;background:#f1f5f9">
          <img src="${imgURL(l.cover_image_url)}" alt="" style="width:100%;height:100%;object-fit:cover">
        </div>

        <div style="padding:12px">
          <!-- ê±°ë˜íƒ€ì… + ê°€ê²© (í•œ ì¤„) -->
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
            <span style="display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #cbd5e1;font-size:12px;color:#334155;background:#f8fafc;">
              ${dealLabel(l)}
            </span>
            <span style="font-weight:900;font-size:14px;">${priceLabel(l)}</span>
          </div>

          <!-- ì œëª© -->
          <div style="font-weight:800;margin-bottom:4px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;">
            ${l.title || '(ì œëª©ì—†ìŒ)'}
          </div>

          <!-- ì£¼ì†Œ -->
          <div style="color:#475569;font-size:13px;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
            ${(l.sigungu||'')} ${(l.road_name||'')} ${(l.lot_no||'')}
          </div>

          <!-- ì¶”ì²œ ê¸°ì¤€ ë°•ìŠ¤ (ë§ì¤„ì„ ì²˜ë¦¬ ê°•í™”) -->
          ${typeof l.basis_listing_id === 'number' ? `
            <div style="margin-top:6px;padding:8px;border:1px dashed #cbd5e1;border-radius:10px;background:#f8fafc">
              <div style="font-size:12px;color:#64748b;margin-bottom:6px">ì¶”ì²œ ê¸°ì¤€</div>
              <div style="display:flex;gap:8px;align-items:center;min-width:0;">
                <div style="width:48px;height:36px;overflow:hidden;border-radius:6px;background:#e2e8f0;flex:0 0 auto;">
                  <img src="${imgURL(l.basis_cover_image_url)}" alt="" style="width:100%;height:100%;object-fit:cover">
                </div>
                <div style="flex:1;min-width:0;">
                  <a href="/listing_detail.html?id=${l.basis_listing_id}"
                    style="display:block;font-size:13px;font-weight:700;color:#0f172a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;">
                    ${l.basis_title || '(ì œëª©ì—†ìŒ)'}
                  </a>
                  <div style="font-size:12px;color:#64748b;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                    ê¸°ì¤€ê¹Œì§€ ì•½ ${(l.basis_dist_m/1000).toFixed(2)} km
                  </div>
                </div>
              </div>
            </div>
          ` : ''}

          <button class="btn" style="margin-top:10px;width:100%"
            onclick="location.href='/listing_detail.html?id=${l.listing_id}'">ìƒì„¸ë³´ê¸°</button>
        </div>
      </div>
    `).join('');

    box.innerHTML = html;
    msg.style.display = 'none';
    box.innerHTML = html;
    msg.style.display = 'none';
  } catch(e){
    console.error(e);
    msg.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
  }
}

// ì´ˆê¸° ë¡œë“œ
document.addEventListener('DOMContentLoaded', () => {
  loadRecoButtons();
  loadRecommendations(); // ì „ì²´ ê¸°ì¤€
});



async function loadRecoButtons(){
  const box = document.getElementById('recoButtons');
  if (!box) return;
  try {
    const res = await fetch('/api/favorites/titles');
    if (res.status===401) {
      box.innerHTML = '<span style="color:#64748b;font-size:12px">ë¡œê·¸ì¸ í•„ìš”</span>';
      return;
    }
    const j = await res.json();
    if (!j.ok) return;
    // ì „ì²´ ë²„íŠ¼
    let html = `<button class="btn" onclick="loadRecommendations()">ì „ì²´</button>`;
    // ì°œí•œ ë§¤ë¬¼ ë²„íŠ¼ë“¤
    html += j.items.map(it =>
      `<button class="btn" onclick="loadRecommendations(${it.listing_id})">${it.title}</button>`
    ).join('');
    box.innerHTML = html;
  } catch (e) {
    console.error('loadRecoButtons error', e);
  }
}

function dealLabel(l){
  const m = {
    sale: 'ë§¤ë§¤',
    jeonse: 'ì „ì„¸',
    monthly: 'ì›”ì„¸',
    presale_right: 'ë¶„ì–‘ê¶Œ',
    occupancy_right: 'ì…ì£¼ê¶Œ'
  };
  return m[l.deal_type] || l.deal_type || '';
}

document.addEventListener('DOMContentLoaded', async () => {
  try {
    const me = await fetch('/api/me').then(r=>r.json());
    const loggedIn = !!me.ok;

    const show = (id, on) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = on ? '' : 'none';
    };

    // ë¡œê·¸ì¸ ìƒíƒœë©´ í”„ë¡œí•„/ë¡œê·¸ì•„ì›ƒë§Œ ë³´ì—¬ì£¼ê³ , ì•„ë‹ˆë©´ ë¡œê·¸ì¸/íšŒì›ê°€ì…ë§Œ
    show('btnLogin',  !loggedIn);
    show('btnSignup', !loggedIn);
    show('btnProfile', loggedIn);
    show('btnLogout',  loggedIn);
  } catch (e) {
    // ì‹¤íŒ¨ ì‹œì—” ë¹„ë¡œê·¸ì¸ ê°€ì •
  }
});

</script>

</body>
</html>
