<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>홈스팟 – 세입자</title>
  <style>
    :root {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --line: #e6e8ee;
      --text: #0f172a;
      --muted: #6b7280;
      --shadow: 0 10px 30px rgba(17, 24, 39, 0.06);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 15px/1.55 ui-sans-serif, system-ui, "Noto Sans KR", sans-serif;
    }
    a { color: inherit; text-decoration: none; }
    header { position: sticky; top: 0; z-index: 20; background: #fff; border-bottom: 1px solid var(--line); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px 24px; }
    .row { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; }
    .logo { width: 28px; height: 28px; border-radius: 8px; background: linear-gradient(135deg, #2563eb, #8b5cf6); }
    .right { margin-left: auto; display: flex; gap: 10px; }
    .btn {
      padding: 10px 14px; border: 1px solid var(--line); border-radius: 12px;
      background: #fff; cursor: pointer;
    }
    .btn.primary { background: #2563eb; color: #fff; border-color: transparent; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,0.08); }

    .hero {
      margin-top: 18px; border-radius: 20px; padding: 28px;
      background: radial-gradient(900px 350px at 15% -50%, #dbeafe 10%, transparent 60%),
                  linear-gradient(135deg, #eff6ff, #f5f3ff);
      border: 1px solid var(--line); box-shadow: var(--shadow);
    }
    .hero h1 { margin: 0 0 8px; font-size: 26px; }

    .search {
      display: flex; gap: 10px; align-items: center;
      background: #fff; border: 1px solid var(--line); border-radius: 999px;
      padding: 10px 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.03); width: 100%;
    }
    .search select {
      border: 1px solid var(--line); border-radius: 999px;
      padding: 8px 10px; background: #fff; outline: 0;
    }
    .search input { border: 0; outline: 0; flex-grow: 1; font-size: 16px; background: transparent; padding: 6px 4px; }
    .search button { margin-left: auto; }

    .filterbar { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
    .chip { border: 1px solid var(--line); background: #fff; border-radius: 999px; padding: 8px 12px; cursor: pointer; }
    .chip.active { background: #eef2ff; border-color: #c7d2fe; }

    .section-title { display: flex; align-items: center; justify-content: space-between; margin-top: 20px; }
    .grid { display: grid; gap: 16px; }
    .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width: 1024px) { .grid-3 { grid-template-columns: 1fr; } }

    .card {
      background: #fff; border: 1px solid var(--line); border-radius: 16px;
      padding: 18px; box-shadow: var(--shadow); position: relative; overflow: hidden;
    }
    .card .desc { opacity: 0.85; }
    .thumb {
      position: absolute; right: 16px; bottom: 16px;
      width: 70px; height: 70px; border-radius: 14px;
      background: rgba(255,255,255,0.25); display: grid; place-items: center; font-size: 28px;
    }

    .cat { color: #fff; }
    .cat.house     { background: linear-gradient(135deg, #60a5fa, #3b82f6); }
    .cat.apartment { background: linear-gradient(135deg, #f87171, #ef4444); }
    .cat.office    { background: linear-gradient(135deg, #34d399, #059669); }
    .cat.rowhouse  { background: linear-gradient(135deg, #22d3ee, #06b6d4); }
    .cat.detached  { background: linear-gradient(135deg, #a3e635, #84cc16); }
    .cat.sale      { background: linear-gradient(135deg, #a78bfa, #7c3aed); }
    .cat.allsearch    { background: linear-gradient(135deg, #f472b6, #ec4899); }
    .cat.favorites { background: linear-gradient(135deg, #fb7185, #f59e0b); }

    .placeholder { padding: 14px; border: 1px dashed var(--line); border-radius: 12px; background: #fff; color: #6b7280; text-align: center; }
    .favbar { display: flex; gap: 10px; overflow: auto; }
    .fav { min-width: 220px; background: #fff; border: 1px solid var(--line); border-radius: 12px; padding: 12px; }
  </style>
</head>
<body>

<header>
  <div class="wrap row">
    <div class="brand">
      <div class="logo"></div>
      홈스팟
    </div>
    <nav class="right">
      <a class="btn" href="tenant_favorites.html">관심목록</a>

      <!-- 비로그인일 때 -->
      <a class="btn" id="btnLogin" href="login.html">로그인</a>
      <a class="btn primary" id="btnSignup" href="tenant_signup.html">회원가입</a>

      <!-- 로그인 후 보이게 -->
      <a class="btn" id="btnProfile" href="profile_setting.html" style="display:none">프로필</a>
      <a class="btn" id="btnLogout" href="/logout" style="display:none">로그아웃</a>
    </nav>
  </div>
</header>

<main class="wrap">

  <section class="hero">
    <h1>조건 맞는 집, 빠르게 찾자 🧭</h1>

    <!-- 검색 바: 유형 드롭다운 + 검색어 + 버튼 -->
    <div class="search">
      <label for="ptype" style="font-size:12px; color:#64748b;">유형</label>
      <select id="ptype" aria-label="매물 유형 선택">
        <option value="all">전체</option> 
        <option value="apartment">아파트</option>
        <option value="officetel">오피스텔</option>
        <option value="rowhouse">연립·다세대</option>
        <option value="detached">단독주택</option>
      </select>
      <input id="q" placeholder="지역 · 지하철역 · 키워드로 검색" />
      <button class="btn" onclick="goSearch()">검색</button>
    </div>
    <section id="results" class="section" style="margin-top:16px; display:none">
      <div class="section-title" style="display:flex;align-items:center;gap:8px">
        <h3 style="margin:0">검색 결과</h3>
        <span id="resultCount" class="tag">0건</span>
      </div>
      <div id="resultGrid" style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;"></div>
      <div id="pager" style="display:flex;gap:8px;justify-content:center;margin-top:10px;"></div>
    </section>
  </section>

  <!-- 카테고리 카드 -->
  <section class="grid grid-3" style="margin-top:16px">
    <a class="card cat apartment" href="search_apartment.html">
      <h3>아파트</h3>
      <div class="desc">단지 정보 · 실거래가 알림</div>
      <div class="thumb">🏢</div>
    </a>

    <a class="card cat office" href="search_officetel.html">
      <h3>오피스텔</h3>
      <div class="desc">다양한 옵션과 합리적 전월세</div>
      <div class="thumb">🏙️</div>
    </a>

    <a class="card cat rowhouse" href="search_rowhouse.html">
      <h3>연립·다세대</h3>
      <div class="desc">실속 있는 주거 선택지</div>
      <div class="thumb">🏘️</div>
    </a>

    <a class="card cat detached" href="search_detached.html">
      <h3>단독주택</h3>
      <div class="desc">마당/주차 등 라이프스타일별 선택</div>
      <div class="thumb">🏠</div>
    </a>

    <a class="card cat allsearch" href="all_listings.html">
          <h3>전체 매물</h3>
          <div class="desc">모든 매물 모아보기</div>
          <div class="thumb" aria-hidden="true">❤</div>
        </a>

    <a class="card cat favorites" href="tenant_favorites.html">
      <h3>내 찜목록</h3>
      <div class="desc">저장한 매물 모아보기</div>
      <div class="thumb" aria-hidden="true">❤</div>
    </a>

    
  </section>

  <!--  추천 매물 -->
  <div class="section-title" style="margin-top:20px; margin-bottom:12px; display:flex; align-items:center; gap:8px;">
    <h2 style="margin:0">추천 매물</h2>
    <div id="recoButtons" style="display:flex; gap:6px; flex-wrap:wrap;"></div>
  </div>
  <div id="recoGrid" style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;"></div>
  <div id="recoMsg" class="placeholder" style="display:none;margin-top:8px;">추천을 불러오는 중...</div>

</main>

<script>
  // 상태 저장 (페이징에 필요)
  const __searchState = { type:'all', q:'', page:1, pageSize:12 };

  const $ = (s)=>document.querySelector(s);
  function imgURL(u){
    if(!u) return 'https://picsum.photos/seed/placeholder/400/260';
    if(/^https?:\/\//i.test(u) || /^data:/i.test(u) || u.startsWith('/uploads/')) return u;
    return '/uploads/'+u.replace(/^\/+/, '');
  }
  function money10kToKRW(n){
    if(n==null || isNaN(n)) return '';
    n = Number(n);
    const eok = Math.floor(n / 10000);
    const man = n % 10000;
    if (eok>0 && man>0) return `${eok}억 ${man.toLocaleString()}만`;
    if (eok>0) return `${eok}억`;
    return `${man.toLocaleString()}만`;
  }
  function priceLabel(l){
    if(l.deal_type==='sale'   && l.price_sale_10k!=null) return `매매 ${money10kToKRW(l.price_sale_10k)}`;
    if(l.deal_type==='jeonse' && l.deposit_10k!=null)    return `전세 ${money10kToKRW(l.deposit_10k)}`;
    if(l.deal_type==='monthly'){
      const dep = l.deposit_10k!=null ? money10kToKRW(l.deposit_10k) : null;
      const rent= l.rent_10k!=null    ? money10kToKRW(l.rent_10k)    : null;
      if(dep && rent) return `월세 ${dep} / ${rent}`;
      if(rent) return `월세 ${rent}`;
      if(dep)  return `보증금 ${dep}`;
    }
    if(l.deal_type==='yearly' && l.rent_annual_10k!=null) return `연세 ${money10kToKRW(l.rent_annual_10k)}`;
    return '';
  }

  // 메인: 검색 실행 (이동 X)
  async function goSearch(page=1){
    const typeSel = document.getElementById('ptype');
    const input   = document.getElementById('q');

    const type = (typeSel?.value || 'all');
    const q    = (input?.value || '').trim();

    const params = new URLSearchParams({
      type, q, page:String(page), pageSize:'12'
    });

    const res = await fetch('/api/listings/search?' + params.toString());
    const j = await res.json();
    if (!j.ok) { alert('검색 실패'); return; }

    const box   = document.getElementById('results');
    const grid  = document.getElementById('resultGrid');
    const tag   = document.getElementById('resultCount');
    const pager = document.getElementById('pager');

    // 요소가 없으면 조용히 종료 (개발 중 안정성)
    if (!box || !grid || !tag || !pager) {
      console.warn('[goSearch] results container not found');
      return;
    }

    box.style.display = '';
    tag.textContent = `${j.total}건`;

    const money10k = (n)=>{
      if(n==null || isNaN(n)) return '';
      n = Number(n);
      const eok = Math.floor(n/10000), man = n%10000;
      if(eok>0 && man>0) return `${eok}억 ${man.toLocaleString()}만`;
      if(eok>0) return `${eok}억`;
      return `${man.toLocaleString()}만`;
    };
    const priceLabel = (l)=>{
      if(l.deal_type==='sale'   && l.price_sale_10k!=null) return `매매 ${money10k(l.price_sale_10k)}`;
      if(l.deal_type==='jeonse' && l.deposit_10k!=null)    return `전세 ${money10k(l.deposit_10k)}`;
      if(l.deal_type==='monthly'){
        const dep=l.deposit_10k!=null?money10k(l.deposit_10k):null;
        const rent=l.rent_10k!=null?money10k(l.rent_10k):null;
        if(dep&&rent) return `월세 ${dep} / ${rent}`;
        if(rent) return `월세 ${rent}`;
        if(dep)  return `보증금 ${dep}`;
      }
      if(l.deal_type==='yearly' && l.rent_annual_10k!=null) return `연세 ${money10k(l.rent_annual_10k)}`;
      return '';
    };
    const imgURL = (u)=>{
      if(!u) return 'https://picsum.photos/seed/placeholder/400/260';
      if(/^https?:\/\//i.test(u) || /^data:/i.test(u) || u.startsWith('/uploads/')) return u;
      return '/uploads/'+u.replace(/^\/+/, '');
    };

    grid.innerHTML = j.items.map(l => `
      <div class="card" style="border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;background:#fff">
        <div style="aspect-ratio:4/2.6;overflow:hidden;background:#f1f5f9">
          <img src="${imgURL(l.cover_image_url)}" alt="" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div style="padding:10px">
          <div style="font-weight:800;margin-bottom:4px">${l.title || '(제목없음)'}</div>
          <div style="color:#475569;font-size:13px;margin-bottom:6px">
            ${(l.sigungu||'')} ${(l.road_name||'')} ${(l.lot_no||'')}
          </div>
          <div style="font-weight:900">${priceLabel(l)}</div>
          <button class="btn" style="margin-top:8px;width:100%"
            onclick="location.href='/listing_detail.html?id=${l.listing_id}'">상세보기</button>
        </div>
      </div>
    `).join('');

    const last = Math.max(1, Math.ceil(j.total / j.pageSize));
    const cur  = j.page;
    const btn = (p, label, disabled)=> `<button class="btn" ${disabled?'disabled':''} onclick="goSearch(${p})">${label}</button>`;
    let html = '';
    html += btn(Math.max(1,cur-1), '이전', cur<=1);
    for(let p=Math.max(1,cur-2); p<=Math.min(last,cur+2); p++){
      html += btn(p, String(p), p===cur);
    }
    html += btn(Math.min(last,cur+1), '다음', cur>=last);
    pager.innerHTML = html;
  }

  // Enter 키로도 검색
  document.getElementById('q')?.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') goSearch(1);
  });

  async function loadRecommendations(basisId){
  const box = document.getElementById('recoGrid');
  const msg = document.getElementById('recoMsg');
  msg.style.display = '';
  msg.textContent = '추천 불러오는 중...';

  try {
    const url = basisId
      ? `/api/recommendations/near-favorites?basis=${basisId}`
      : `/api/recommendations/near-favorites`;
    const res = await fetch(url);
    if (res.status===401) {
      msg.textContent = '로그인 후 추천을 볼 수 있어요.';
      return;
    }
    const j = await res.json();
    if (!j.ok || !j.items) {
      msg.textContent = '추천 없음';
      return;
    }

    const html = j.items.map(l => `
      <div class="card" style="border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;background:#fff">
        <div style="aspect-ratio:4/2.6;overflow:hidden;background:#f1f5f9">
          <img src="${imgURL(l.cover_image_url)}" alt="" style="width:100%;height:100%;object-fit:cover">
        </div>

        <div style="padding:12px">
          <!-- 거래타입 + 가격 (한 줄) -->
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
            <span style="display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #cbd5e1;font-size:12px;color:#334155;background:#f8fafc;">
              ${dealLabel(l)}
            </span>
            <span style="font-weight:900;font-size:14px;">${priceLabel(l)}</span>
          </div>

          <!-- 제목 -->
          <div style="font-weight:800;margin-bottom:4px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;">
            ${l.title || '(제목없음)'}
          </div>

          <!-- 주소 -->
          <div style="color:#475569;font-size:13px;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
            ${(l.sigungu||'')} ${(l.road_name||'')} ${(l.lot_no||'')}
          </div>

          <!-- 추천 기준 박스 (말줄임 처리 강화) -->
          ${typeof l.basis_listing_id === 'number' ? `
            <div style="margin-top:6px;padding:8px;border:1px dashed #cbd5e1;border-radius:10px;background:#f8fafc">
              <div style="font-size:12px;color:#64748b;margin-bottom:6px">추천 기준</div>
              <div style="display:flex;gap:8px;align-items:center;min-width:0;">
                <div style="width:48px;height:36px;overflow:hidden;border-radius:6px;background:#e2e8f0;flex:0 0 auto;">
                  <img src="${imgURL(l.basis_cover_image_url)}" alt="" style="width:100%;height:100%;object-fit:cover">
                </div>
                <div style="flex:1;min-width:0;">
                  <a href="/listing_detail.html?id=${l.basis_listing_id}"
                    style="display:block;font-size:13px;font-weight:700;color:#0f172a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;">
                    ${l.basis_title || '(제목없음)'}
                  </a>
                  <div style="font-size:12px;color:#64748b;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                    기준까지 약 ${(l.basis_dist_m/1000).toFixed(2)} km
                  </div>
                </div>
              </div>
            </div>
          ` : ''}

          <button class="btn" style="margin-top:10px;width:100%"
            onclick="location.href='/listing_detail.html?id=${l.listing_id}'">상세보기</button>
        </div>
      </div>
    `).join('');

    box.innerHTML = html;
    msg.style.display = 'none';
    box.innerHTML = html;
    msg.style.display = 'none';
  } catch(e){
    console.error(e);
    msg.textContent = '불러오기 실패';
  }
}

// 초기 로드
document.addEventListener('DOMContentLoaded', () => {
  loadRecoButtons();
  loadRecommendations(); // 전체 기준
});



async function loadRecoButtons(){
  const box = document.getElementById('recoButtons');
  if (!box) return;
  try {
    const res = await fetch('/api/favorites/titles');
    if (res.status===401) {
      box.innerHTML = '<span style="color:#64748b;font-size:12px">로그인 필요</span>';
      return;
    }
    const j = await res.json();
    if (!j.ok) return;
    // 전체 버튼
    let html = `<button class="btn" onclick="loadRecommendations()">전체</button>`;
    // 찜한 매물 버튼들
    html += j.items.map(it =>
      `<button class="btn" onclick="loadRecommendations(${it.listing_id})">${it.title}</button>`
    ).join('');
    box.innerHTML = html;
  } catch (e) {
    console.error('loadRecoButtons error', e);
  }
}

function dealLabel(l){
  const m = {
    sale: '매매',
    jeonse: '전세',
    monthly: '월세',
    presale_right: '분양권',
    occupancy_right: '입주권'
  };
  return m[l.deal_type] || l.deal_type || '';
}

document.addEventListener('DOMContentLoaded', async () => {
  try {
    const me = await fetch('/api/me').then(r=>r.json());
    const loggedIn = !!me.ok;

    const show = (id, on) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = on ? '' : 'none';
    };

    // 로그인 상태면 프로필/로그아웃만 보여주고, 아니면 로그인/회원가입만
    show('btnLogin',  !loggedIn);
    show('btnSignup', !loggedIn);
    show('btnProfile', loggedIn);
    show('btnLogout',  loggedIn);
  } catch (e) {
    // 실패 시엔 비로그인 가정
  }
});

</script>

</body>
</html>
