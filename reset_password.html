<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>비밀번호 재설정</title>
  <style>
    :root{
      --bg:#f4f6f9;
      --card:#ffffff;
      --border:#dcdfe6;
      --text:#1f2d3d;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent-press:#1e40af;
      --danger:#dc2626;
      --ok:#16a34a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      display:flex; align-items:center; justify-content:center;
      min-height:100vh;
      padding:24px;
    }
    .card{
      width:100%;
      max-width:420px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:28px;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
    }
    h1{font-size:22px; margin:0 0 8px}
    p.desc{margin:0 0 18px; color:var(--muted); font-size:14px; line-height:1.5}
    label{display:block; font-size:14px; margin:14px 0 6px}
    input[type="password"]{
      width:100%; padding:12px 12px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:16px;
    }
    .hint{font-size:12px; color:var(--muted); margin-top:6px}
    .error{color:var(--danger); font-size:13px; margin-top:8px; display:none}
    .ok{color:var(--ok); font-size:13px; margin-top:8px; display:none}
    .row{margin-top:16px}
    button{
      width:100%;
      padding:12px 16px;
      border:0;
      border-radius:10px;
      font-size:16px;
      cursor:pointer;
      background:var(--accent);
      color:#fff;
    }
    button:disabled{opacity:.6; cursor:not-allowed}
    .note{
      margin-top:14px; font-size:13px; color:var(--muted);
    }
    .token-missing{
      padding:12px; border:1px dashed var(--border);
      border-radius:10px; background:#fafafa; color:var(--danger); font-size:14px;
      margin-bottom:14px; display:none;
    }
    .sr-only{position:absolute; width:1px; height:1px; padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0); white-space:nowrap; border:0}
  </style>
</head>
<body>
  <main class="card" role="main" aria-labelledby="title">
    <h1 id="title">비밀번호 재설정</h1>
    <p class="desc">이메일로 받은 링크를 통해 접속하셨다면, 새 비밀번호를 아래에 입력해 주세요.</p>

    <div id="tokenWarning" class="token-missing" role="alert">
      토큰이 없습니다. 링크가 올바르지 않거나 만료되었을 수 있습니다. 
      <br/>다시 <a href="/find_pwd.html">비밀번호 재설정 요청</a>을 해주세요.
    </div>

    <form id="resetForm" method="POST" action="/reset-password" novalidate>
      <input type="hidden" name="token" id="tokenField" />

      <label for="password">새 비밀번호</label>
      <input type="password" id="password" name="password" autocomplete="new-password" required
             minlength="8" placeholder="최소 8자 (영문/숫자/특수문자 조합 권장)" />
      <div class="hint">영문 대/소문자, 숫자, 특수문자를 조합하면 더 안전해요.</div>

      <label for="confirmPassword">새 비밀번호 확인</label>
      <input type="password" id="confirmPassword" name="confirmPassword" autocomplete="new-password" required minlength="8"
             placeholder="비밀번호 재입력" />
      <div id="mismatch" class="error">비밀번호가 일치하지 않습니다.</div>
      <div id="match" class="ok">비밀번호가 일치합니다.</div>

      <div class="row">
        <button id="submitBtn" type="submit" disabled>비밀번호 변경</button>
      </div>
      <div class="note">버튼이 비활성화되어 있다면 토큰이 없거나, 비밀번호가 조건에 맞지 않습니다.</div>
    </form>
  </main>

  <script>
    (function(){
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      const tokenField = document.getElementById('tokenField');
      const warning = document.getElementById('tokenWarning');
      const submitBtn = document.getElementById('submitBtn');
      const form = document.getElementById('resetForm');
      const pwd = document.getElementById('password');
      const cpw = document.getElementById('confirmPassword');
      const mismatch = document.getElementById('mismatch');
      const match = document.getElementById('match');

      function validate(){
        const hasToken = !!token;
        const p1 = pwd.value.trim();
        const p2 = cpw.value.trim();
        const lengthOK = p1.length >= 8 && p2.length >= 8;
        const same = p1 && p1 === p2;

        mismatch.style.display = (p1 && p2 && !same) ? 'block' : 'none';
        match.style.display = (p1 && p2 && same) ? 'block' : 'none';

        submitBtn.disabled = !(hasToken && lengthOK && same);
      }

      if(!token){
        warning.style.display = 'block';
        submitBtn.disabled = true;
      } else {
        tokenField.value = token;
      }

      pwd.addEventListener('input', validate);
      cpw.addEventListener('input', validate);
      document.addEventListener('DOMContentLoaded', validate);

      form.addEventListener('submit', function(e){
        // 마지막 방어선: 토큰 유무/일치 확인
        if(!tokenField.value){
          e.preventDefault();
          alert('토큰이 없습니다. 링크를 다시 확인해주세요.');
          return;
        }
        if(pwd.value !== cpw.value){
          e.preventDefault();
          alert('비밀번호가 서로 다릅니다.');
          return;
        }
      });
    })();
  </script>
</body>
</html>
