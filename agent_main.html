<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>í™ˆìŠ¤íŒŸ â€“ ì¤‘ê°œì‚¬</title>
<style>
  .input{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none}
  .pager{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
  .pager .btn[disabled]{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
  .pager .num{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .pager .num.active{background:#2563eb;color:#fff;border-color:#2563eb}
  :root{
    --bg:#f7f8fb; --panel:#ffffff; --line:#e6e8ee; --text:#0f172a; --muted:#6b7280;
    --shadow:0 10px 30px rgba(17,24,39,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.55 ui-sans-serif,system-ui,'Noto Sans KR',sans-serif}
  a{color:inherit;text-decoration:none}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:20}
  .wrap{max-width:1200px;margin:0 auto;padding:16px 24px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .brand{display: flex; align-items: center; gap: 10px; font-weight: 800;}
  .logo {
      width: 23px;
      height: 23px;
      border-radius: 8px;
      object-fit: cover;
    }
  .right{margin-left:auto;display:flex;gap:10px}
  .btn{padding:10px 14px;border: 1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
  .btn.primary{background:#B3E5FC; border-color:transparent; color: #000;}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.08)}
  .pill{border-radius:999px;padding:6px 10px;border:1px solid var(--line);background:#fff;font-size:12px;color:#334155}

  /* ë°°ë„ˆ */
  .notice{display:flex;gap:16px;align-items:center;border:1px solid var(--line);border-radius:16px;padding:16px 18px;
    background:linear-gradient(135deg,#eff6ff,#f5f3ff);box-shadow:var(--shadow)}

  /* Grid & Card */
  .grid{display:grid;gap:16px}
  .grid.grid-auto {
  display: flex !important;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
}

.grid.grid-auto > .card.kpi {
  flex: none;
  width: 280px;
  height: 140px;
  border-radius: 14px;
  padding: 16px 18px;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  justify-content: space-between;
  color: #fff;
}

  .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:1024px){.grid-3{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
  .muted{color:var(--muted)}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin-top:22px}

  /* ì»¬ëŸ¬ KPI ì¹´ë“œ */
  .kpi{color:#fff;display:flex;align-items:center;justify-content:space-between}
  .kpi .num{font-size:26px;font-weight:800}
  .kpi.views{background:linear-gradient(135deg,#60a5fa,#3b82f6);}
  .kpi.asks {background:linear-gradient(135deg,#34d399,#059669);}
  .kpi.pending{background:linear-gradient(135deg,#fbbf24,#f59e0b);}

  /* ë¹ ë¥¸ ì•¡ì…˜ (ì»¬ëŸ¬ ì¹´ë“œ) */
  .actions {
  display: grid;
  gap: 10px;
  grid-template-columns: repeat(2, 280px);
  justify-content: center;
}
  .action{width: 280px; height: 140px;flex:1 1 220px;display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-radius:14px;color:#fff}
  .action.manage {background:linear-gradient(135deg,#8b5cf6,#6366f1);}
  .action.create {background:linear-gradient(135deg,#2563eb,#60a5fa);}
  .action.inbox  {background:linear-gradient(135deg,#f472b6,#ec4899);}

  /* í…Œì´ë¸” */
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left}
  th{background:#fcfcff}

  /* placeholder */
  .placeholder{padding:14px;border:1px dashed var(--line);border-radius:12px;background:#fff;color:#6b7280;text-align:center}
  .grid-auto { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
  .meta { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:4px; }
  .btn.danger { border-color:#fecaca; }
  .btn.danger:hover { background:#fee2e2; }
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="brand">
      <img class="logo" src="home.jpg" alt="ë¡œê³ " />
      í™ˆìŠ¤íŒŸ
    </div>
    <nav class="right">
      <a class="btn" href="#">ì•Œë¦¼</a>
      <a class="btn" href="login.html">ë¡œê·¸ì¸</a>
      <a class="btn primary" href="agent_signup.html">íšŒì›ê°€ì…</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- ë°°ë„ˆ -->
  <div class="notice" style="margin-top:12px">
    <div style="font-size:22px">ğŸ“¢</div>
    <div style="flex:1">
      <b>ê²€ìˆ˜ ì •ì±… ê°œí¸</b> â€“ ìµœê·¼ ë“±ë¡ ë§¤ë¬¼ì€ í‰ê·  <b>2ì‹œê°„ ì´ë‚´</b> ê²€ìˆ˜ ì™„ë£Œ. ì‚¬ì§„ ê·œê²©/ì£¼ì†Œ í‘œê¸° ê°€ì´ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.
    </div>
    <button class="btn">ê°€ì´ë“œ ë³´ê¸°</button>
  </div>

<section class="dashboard-wrap" style="margin-top:16px; display:flex; gap:16px; flex-wrap:nowrap; justify-content:center;">
  <div class="card kpi views" style="flex:1; min-width: 200px;">
    <div>
      <div class="muted" style="color:#e3f2ff">ì˜¤ëŠ˜ ì¡°íšŒìˆ˜</div>
      <div class="num" id="kpi-views">1,248</div>
    </div>
    <div>ğŸ“ˆ</div>
  </div>
  <div class="card kpi asks" style="flex:1; min-width: 200px;">
    <div>
      <div class="muted" style="color:#dcfce7">ì˜¤ëŠ˜ ë¬¸ì˜ìˆ˜</div>
      <div class="num" id="kpi-asks">24</div>
    </div>
    <div>ğŸ’¬</div>
  </div>
  <div class="action create" style="flex:1; min-width: 200px; height: auto; padding: 16px 18px; border-radius: 14px; color:#fff; display:flex; align-items:center; justify-content:space-between; background: linear-gradient(135deg,#2563eb,#60a5fa);">
    <div><b>ë§¤ë¬¼ ë“±ë¡</b><div class="muted" style="color:#e5f1ff">ì‚¬ì§„/ì˜µì…˜/ì£¼ì†Œ ì…ë ¥</div></div>
    <a class="btn" href="property_listing.html" style="color:#0f172a;font-weight:700">ë“±ë¡</a>
  </div>
  <div class="action inbox" style="flex:1; min-width: 200px; height: auto; padding: 16px 18px; border-radius: 14px; color:#fff; display:flex; align-items:center; justify-content:space-between; background: linear-gradient(135deg,#f472b6,#ec4899);">
    <div><b>ë¬¸ì˜í•¨</b><div class="muted" style="color:#ffe4f1">ì‹¤ì‹œê°„ ìƒë‹´ ì—°ê²°</div></div>
    <button class="btn" onclick="alert('ë¬¸ì˜í•¨ ì´ë™')">ë³´ê¸°</button>
  </div>
</section>

  <!-- ìµœê·¼ ë¬¸ì˜/ì•Œë¦¼/ê°€ì´ë“œ -->
  <section class="grid grid-3" style="margin-top:16px">
    <div class="card">
      <div class="section-title"><h3 style="margin:0">ìµœê·¼ ë¬¸ì˜</h3><span class="pill">ì‹¤ì‹œê°„</span></div>
      <div id="inbox" class="placeholder" style="margin-top:8px">ë¬¸ì˜ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜ˆì •â€¦</div>
    </div>
    <div class="card">
      <div class="section-title"><h3 style="margin:0">ì•Œë¦¼</h3><span class="pill">ì§€ë‚œ 24ì‹œê°„</span></div>
      <ul id="alerts" style="margin:8px 0 0 18px;padding:0">
        <li class="muted">ì•Œë¦¼ ë°ì´í„° ì—°ê²° ì „â€¦</li>
      </ul>
    </div>
    <div class="card">
      <div class="section-title"><h3 style="margin:0">ê³µì§€/ê°€ì´ë“œ</h3><a href="#" class="pill">ë¬¸ì„œ</a></div>
      <div class="muted" style="margin-top:10px">
        ì‚¬ì§„ ê·œê²©, ì£¼ì†Œ ì‘ì„±ë²•, í—ˆìœ„ë§¤ë¬¼ ë°©ì§€ ì •ì±… ë“± ìš´ì˜ ê°€ì´ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.
      </div>
    </div>
  </section>

  <!-- ë“±ë¡ëœ ë§¤ë¬¼ -->
<div class="section-title">
  <h2 style="margin:22px 0 6px">ë“±ë¡ëœ ë§¤ë¬¼</h2>
  <div style="display:flex;gap:8px;align-items:center">
    <input id="listing-search" type="search" placeholder="ì œëª©/ì„¤ëª…/ì£¼ì†Œ ê²€ìƒ‰" class="input" style="width:280px">
    <span class="pill">ì¡°íšŒìˆ˜/ë¬¸ì˜ìˆ˜ ì‹¤ì‹œê°„ ë°˜ì˜ ì˜ˆì •</span>
    <button class="btn" onclick="alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ì¶”í›„)')">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
  </div>
</div>
<div id="agent-list" class="placeholder" style="margin-top:8px">
  ë“±ë¡ëœ ë§¤ë¬¼ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜ˆì •â€¦
</div>
<div id="agent-pager" style="margin-top:12px"></div>

<script>
(function(){
  const state = { page:1, pageSize:10, q:'' };

  const fmt = n => (n==null ? '' : Number(n).toLocaleString('ko-KR'));
  const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const propText = p => ({ apartment:'ì•„íŒŒíŠ¸', officetel:'ì˜¤í”¼ìŠ¤í…”', rowhouse:'ë¹Œë¼/ì—°ë¦½', detached:'ë‹¨ë…/ë‹¤ê°€êµ¬' }[p] || p);
  const statusText = s => ({ active:'ë…¸ì¶œì¤‘', sold:'ê±°ë˜ì™„ë£Œ', removed:'ë¹„ê³µê°œ' }[s] || s);
  function dealText(i){
    if(i.deal_type==='sale')     return `ë§¤ë§¤ ${fmt(i.price_sale_10k)}ë§Œì›`;
    if(i.deal_type==='jeonse')   return `ì „ì„¸ ${fmt(i.deposit_10k)}ë§Œì›`;
    if(i.deal_type==='monthly'){
      if(i.rent_pay_cycle==='yearly') return `ì—°ì„¸ ë³´ì¦ê¸ˆ ${fmt(i.deposit_10k)} / ì—°ì„¸ ${fmt(i.rent_annual_10k)}ë§Œì›`;
      return `ì›”ì„¸ ${fmt(i.deposit_10k)} / ${fmt(i.rent_10k)}ë§Œì›`;
    }
    return i.deal_type;
  }

  const qs = (o)=>Object.entries(o).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');

  async function loadMyListings(){
    const listBox  = document.getElementById('agent-list');
    const pagerBox = document.getElementById('agent-pager');
    listBox.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
    pagerBox.innerHTML = '';

    const res  = await fetch(`/api/my-listings?${qs({page:state.page,pageSize:state.pageSize,q:state.q})}`, { credentials:'same-origin' });
    if(!res.ok){ listBox.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'; return; }
    const data = await res.json();
    if(!data.ok){ listBox.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'; return; }

    const { items=[], total=0 } = data;
    if(items.length===0){
      listBox.innerHTML = '<div class="placeholder">ë“±ë¡ëœ ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    // ----- ëª©ë¡ ë Œë”(ì¹´ë“œ 3ì—´) -----
    const grid = document.createElement('div');
    grid.className = 'grid grid-3';
    items.forEach(i => {
      const img = i.main_image_url ? `/uploads/${i.main_image_url}` : null;
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="row" style="gap:12px;align-items:flex-start">
          <div class="thumb" style="width:140px;height:100px;border-radius:12px;background:#f2f4f8;overflow:hidden;flex:0 0 140px">
            ${img ? `<img src="${img}" alt="" style="width:100%;height:100%;object-fit:cover">`
                  : `<div class="muted" style="display:flex;align-items:center;justify-content:center;height:100%">ì´ë¯¸ì§€ ì—†ìŒ</div>`}
          </div>
          <div style="flex:1">
            <div class="meta">
              <span class="pill">${propText(i.property_type)}</span>
              <span class="pill">${dealText(i)}</span>
              <span class="pill">${statusText(i.status)}</span>
            </div>
            <div style="font-weight:800">${esc(i.title)}</div>
            ${i.description ? `<div class="muted" style="margin-top:4px;max-height:3.3em;overflow:hidden">${esc(i.description)}</div>` : ''}
            <div class="muted" style="margin-top:6px;font-size:12px">ë“±ë¡ì¼ ${new Date(i.created_at).toLocaleDateString('ko-KR')}</div>
          </div>
          <div style="display:flex;gap:8px">
            <a class="btn" href="/property_listing.html?edit=${i.listing_id}">ìˆ˜ì •</a>
            <button class="btn danger" data-del="${i.listing_id}">ì‚­ì œ</button>
          </div>
        </div>`;
      grid.appendChild(card);
    });
    listBox.replaceWith(grid);
    grid.id = 'agent-list';

    // ----- í˜ì´ì € ë Œë” -----
    const pages = Math.max(1, Math.ceil(total / state.pageSize));
    if (pages > 1){
      const p = document.createElement('div');
      p.className = 'pager';
      const prev = document.createElement('button');
      prev.className = 'btn'; prev.textContent = 'ì´ì „';
      prev.disabled = state.page <= 1;
      prev.onclick = () => { state.page--; loadMyListings(); };

      const next = document.createElement('button');
      next.className = 'btn'; next.textContent = 'ë‹¤ìŒ';
      next.disabled = state.page >= pages;
      next.onclick = () => { state.page++; loadMyListings(); };

      p.appendChild(prev);

      // ì¤‘ì•™ ìˆ«ì(ìµœëŒ€ 7ê°œ ìœˆë„ìš°)
      const win = 3;
      const start = Math.max(1, state.page - win);
      const end   = Math.min(pages, state.page + win);
      for (let i = start; i <= end; i++){
        const b = document.createElement('button');
        b.className = 'num' + (i===state.page ? ' active' : '');
        b.textContent = i;
        b.onclick = () => { state.page = i; loadMyListings(); };
        p.appendChild(b);
      }

      p.appendChild(next);
      pagerBox.replaceChildren(p);
    } else {
      pagerBox.innerHTML = '';
    }
  }

  // ê²€ìƒ‰ ì…ë ¥(ë””ë°”ìš´ìŠ¤)
  function debounce(fn,ms){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),ms)}}
  const searchInput = document.getElementById('listing-search');
  if (searchInput){
    const run = debounce(()=>{ state.q = searchInput.value.trim(); state.page = 1; loadMyListings(); }, 300);
    searchInput.addEventListener('input', run);
    searchInput.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); run(); } });
  }

  // ì‚­ì œ ë²„íŠ¼(ì„±ê³µ ì‹œ ëª©ë¡ ë¦¬ë¡œë“œ)
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('button.btn.danger[data-del]');
    if (!btn) return;
    const id = btn.getAttribute('data-del');
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ì–´ìš”?')) return;

    const res = await fetch(`/api/listings/${id}`, { method:'DELETE', credentials:'same-origin' });
    const out = await res.json().catch(()=>({}));
    if (res.ok && out.ok) {
      // í˜„ì¬ í˜ì´ì§€ì—ì„œ ì•„ì´í…œ 1ê°œ ì§€ì›Œì¡Œìœ¼ë‹ˆ ìƒí™©ì— ë”°ë¼ ì• í˜ì´ì§€ë¡œ ë‹¹ê²¨ì£¼ê¸°
      if (document.querySelectorAll('#agent-list .card').length === 1 && state.page > 1) {
        state.page -= 1;
      }
      loadMyListings();
    } else {
      alert(out.message || 'ì‚­ì œ ì‹¤íŒ¨');
    }
  });

  // ìµœì´ˆ ë¡œë”©
  document.addEventListener('DOMContentLoaded', loadMyListings);
})();
</script>
</main>

<script>
  // KPI ì‹œê°íš¨ê³¼ (ë‚˜ì¤‘ì— API/WebSocketìœ¼ë¡œ êµì²´)
  setInterval(()=>{
    const f=n=>n.toLocaleString();
    const v=document.getElementById('kpi-views'), a=document.getElementById('kpi-asks');
    v.textContent=f(parseInt(v.textContent.replace(/,/g,''))+Math.floor(Math.random()*3));
    a.textContent=(parseInt(a.textContent)+(Math.random()<.3?1:0));
  },3000);
</script>
</body>
</html>
