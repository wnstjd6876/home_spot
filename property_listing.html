<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>매물 등록</title>

  <!-- Quill -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e5e7eb;
      --accent: #2563eb;
      --accent-weak: #e8f0ff;
      --ring: 0 0 0 4px rgba(37, 99, 235, .15);
      --radius: 14px;
      --shadow: 0 10px 30px rgba(2, 6, 23, .1);
      --neutral: #d1d5db;
      --neutral-weak: #f3f4f6;
      --neutral-text: #374151;
      --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b1220;
        --card: #0f172a;
        --text: #e2e8f0;
        --muted: #94a3b8;
        --border: #1e293b;
        --accent: #60a5fa;
        --accent-weak: #0b2a64;
        --ring: 0 0 0 4px rgba(96, 165, 250, .2);
        --shadow: 0 10px 30px rgba(0, 0, 0, .5);
        --neutral: #334155;
        --neutral-weak: #0f172a;
        --neutral-text: #cbd5e1;
      }
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: clamp(16px, 3vw, 32px);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(37,99,235,.08), transparent 40%),
        radial-gradient(1000px 600px at 90% 110%, rgba(99,102,241,.06), transparent 40%),
        var(--bg);
      font-family: var(--font); color: var(--text); line-height: 1.6;
    }
    .shell { max-width: 980px; margin: 0 auto; }
    .title { font-size: clamp(22px,2vw,28px); font-weight: 800; letter-spacing: -.02em; margin: 0 0 12px; display:flex; gap:10px; align-items:center;}
    .title .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#8b5cf6)}
    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: clamp(18px,3vw,28px); margin: 14px 0; }
    .muted { color: var(--muted) }
    .grid { display:grid; gap:16px; }
    @media (min-width: 860px){ .grid-2{grid-template-columns:1fr} }
    .field{display:grid; gap:8px}
    label{font-size:14px; font-weight:600; letter-spacing:-.01em}
    .req{color:var(--accent); margin-left:4px; font-weight:800}
    input, select{height:44px; border:1px solid var(--border); background: color-mix(in oklab, var(--card) 90%, #fff 10%); color:var(--text); border-radius:12px; padding:12px 14px; font-size:16px; outline:none; transition:border-color .2s, box-shadow .2s;}
    input:hover, select:hover{border-color: color-mix(in oklab, var(--accent) 35%, var(--border) 65%)}
    input:focus, select:focus{border-color: var(--accent); box-shadow: var(--ring)}
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0 }
    input[type="number"]{ -moz-appearance: textfield }
    .segmented{display:flex; gap:6px; flex-wrap:wrap}
    .seg-btn{flex:1 0 auto; display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border:1px solid var(--border); background:color-mix(in oklab, var(--card) 85%, #fff 15%); color:var(--text); border-radius:999px; font-size:14px; font-weight:600; cursor:pointer}
    .seg-btn:hover{ border-color: color-mix(in oklab, var(--accent) 35%, var(--border) 65%) }
    .seg-btn[aria-checked="true"]{ background: color-mix(in oklab, var(--accent) 15%, var(--card)); border-color: var(--accent); box-shadow: var(--ring) }
    .hidden-select{ position:absolute!important; opacity:0!important; width:0!important; height:0!important; pointer-events:none!important }
    .hidden{ display:none!important }
    .btn{appearance:none; border:none; border-radius:12px; padding:14px 16px; font-weight:600; cursor:pointer; transition:transform .05s, box-shadow .2s, background-color .2s}
    .btn:active{ transform: translateY(1px) }
    .btn-primary{ background:#E0E0E0; color:#000 }
    .btn-primary:hover{ background:#D6D6D6 }
    .btn-ghost{ background: var(--neutral-weak); color: var(--neutral-text); border: 1px solid var(--neutral) }
    .badge{display:inline-flex; align-items:center; gap:6px; font-size:12px; color:var(--muted); background:color-mix(in oklab, var(--card) 85%, #fff 15%); border:1px solid var(--border); padding:6px 10px; border-radius:999px}
    .badge .dot{width:6px;height:6px;border-radius:50%;background:var(--accent)}
    .ql-toolbar{border:1px solid var(--border)!important; border-bottom:none!important; border-radius:12px 12px 0 0!important; background:color-mix(in oklab, var(--card) 85%, #fff 15%)!important}
    .ql-container.ql-snow{border:1px solid var(--border)!important; border-radius:0 0 12px 12px!important}
    #desc{min-height:200px}
    .uploader{display:flex; gap:8px; align-items:center; margin-top:6px}
    .file-btn{position:relative; overflow:hidden}
    .file-btn input{position:absolute; inset:0; opacity:0; cursor:pointer}
    .gallery{display:grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap:10px; margin-top:10px}
    .thumb{position:relative; border:1px solid var(--border); border-radius:10px; overflow:hidden}
    .thumb img{width:100%; height:100px; object-fit:cover; display:block}
    .thumb button{position:absolute; right:6px; top:6px; font-size:12px; border:1px solid #ff6b81; background:#2a1218; color:#ffd4d9; border-radius:8px; padding:4px 8px; cursor:pointer}
  </style>
</head>
<body>
  <div class="shell">
    <h1 class="title"><span class="dot"></span>매물 등록</h1>

    <!-- ① 기본 정보 & 설명 -->
    <section class="card">
      <h2 class="title" style="font-size:20px">① 기본 정보 & 설명</h2>
      <p class="muted" id="info-sub">아래 정보를 저장하면 매물 번호가 생성됩니다.</p>

      <form id="formInfo" onsubmit="saveInfo(event)" novalidate>
        <div class="grid">
    <div class="field">
      <label for="sigungu">시군구 <span class="req">*</span></label>
      <input id="sigungu" placeholder="예) 관악구" />
    </div>
    <div class="field">
      <label for="road_name">도로명</label>
      <input id="road_name" placeholder="예) 관악로 1" />
    </div>
    <div class="field">
      <label for="lot_no">번지(본-부) <span class="req">*</span></label>
      <input id="lot_no" placeholder="예) 123-4" />
    </div>

  <div class="field">
    <label for="title">건물명 <span class="req">*</span></label>
    <input id="title" placeholder="예) 더블루 아파트 101동 101호" />
  </div>

  <div class="field">
    <label for="builtYear">건축년도</label>
    <input id="builtYear" type="number" min="1900" max="2099" placeholder="예) 1998" />
  </div>

  <div class="field">
  <label id="typeLabel" for="typeSel">건물 종류 <span class="req">*</span></label>
    <select id="typeSel" class="hidden-select">
      <option value="">선택</option>
      <option value="apartment">아파트</option>
      <option value="officetel">오피스텔</option>
      <option value="house">주택(단독)</option>
      <option value="villa">빌라/다세대</option>
      <option value="new">분양/입주</option>
    </select>
    <div class="segmented" role="radiogroup" aria-labelledby="typeLabel" id="typeGroup">
      <button type="button" class="seg-btn" role="radio" aria-checked="false" data-value="apartment">아파트</button>
      <button type="button" class="seg-btn" role="radio" aria-checked="false" data-value="officetel">오피스텔</button>
      <button type="button" class="seg-btn" role="radio" aria-checked="false" data-value="house">주택</button>
      <button type="button" class="seg-btn" role="radio" aria-checked="false" data-value="villa">빌라</button>
      <button type="button" class="seg-btn" role="radio" aria-checked="false" data-value="new">분양/입주</button>
    </div>
    </div>


    <div class="field">
    <label id="dealLabel" for="dealSel">거래 유형 <span class="req">*</span></label>
      <select id="dealSel" class="hidden-select">
        <option value="">선택</option>
        <option value="monthly">월세</option>
        <option value="jeonse">전세</option>
        <option value="sale">매매</option>
        <option value="yearly">연세</option>
      </select>
        <div class="segmented" role="radiogroup" aria-labelledby="dealLabel" id="dealGroup">
          <button type="button" class="seg-btn" role="radio" aria-checked="false" data-value="monthly">월세</button>
          <button type="button" class="seg-btn" role="radio" aria-checked="false" data-value="jeonse">전세</button>
          <button type="button" class="seg-btn" role="radio" aria-checked="false" data-value="sale">매매</button>
          <button type="button" class="seg-btn" role="radio" aria-checked="false" data-value="yearly">연세</button>
        </div>
        </div>
        <div class="field" id="priceField">
          <label id="priceLabel" for="price">가격(만원) <span class="req">*</span></label>
          <input id="price" type="number" min="0" placeholder="예) 45000 (매매/전세)" />
        </div>

        <div class="field hidden" id="depositField">
          <label for="deposit">보증금(만원) <span class="req">*</span></label>
          <input id="deposit" type="number" min="0" placeholder="예) 450" />
        </div>

        <div class="field hidden" id="annualField">
          <label for="annual">연세(만원) <span class="req">*</span></label>
          <input id="annual" type="number" min="0" placeholder="예) 500" />
        </div>

        <div class="field hidden" id="exclusiveAreaField">
          <label for="exclusiveArea">전용 면적 (㎡) <span class="req">*</span></label>
          <input id="exclusiveArea" type="number" step="0.01" placeholder="예) 84.5" />
        </div>

        <div class="field hidden" id="grossAreaField">
          <label for="grossArea">연면적 (㎡) <span class="req">*</span></label>
          <input id="grossArea" type="number" step="0.01" placeholder="예) 120.3" />
        </div>

        <div class="field hidden" id="landAreaField">
          <label for="landArea">대지면적 (㎡) <span class="req">*</span></label>
          <input id="landArea" type="number" step="0.01" placeholder="예) 150.0" />
        </div>

        <div class="field hidden" id="landRightAreaField">
          <label for="landRightArea">대지권 지분 (㎡) <span class="req">*</span></label>
          <input id="landRightArea" type="number" step="0.01" placeholder="예) 50.0" />
        </div>

        <div class="field hidden" id="floorField">
          <label for="floor">층수</label>
          <input id="floor" type="number" step="1" placeholder="예) -1, 1, 12" />
        </div>

        <div class="field" style="grid-column:1 / -1">
          <label for="desc">상세 설명 <span class="req">*</span></label>
          <div class="badge"><span class="dot"></span> 본문에 data:image는 저장 전 제거됩니다. 이미지는 ②에서 파일로 업로드하세요.</div>
          <div id="desc"></div>
        </div>
        </div>

        <div style="display:flex; gap:12px; margin-top:8px">
          <button class="btn btn-ghost" type="button" onclick="resetForm()">취소</button>
          <button class="btn btn-primary" id="btnSaveInfo" type="submit">기본 정보 저장</button>
        </div>
      </form>
    </section>

    <!-- ② 이미지 업로드 -->
    <div style="padding: 20px; border: 1px solid #ccc; border-radius: 10px;">
  <h3 style="display: flex; align-items: center; gap: 5px;">
    ② 이미지 업로드 — 기본 정보 저장 후 사용
    <label for="imageUpload" style="cursor: pointer;">
      <img src="file.jpg" alt="파일 업로드" style="width: 20px; height: 20px; vertical-align: middle;">
    </label>
  </h3>
  <p>아직 매물 번호가 없습니다.</p>

  <!-- multiple 속성 추가 -->
  <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(event)">

  <div id="preview" style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;"></div>
</div>

<script>
  function handleImageUpload(event) {
  const files = event.target.files;
  const preview = document.getElementById('preview');

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const reader = new FileReader();

    reader.onload = function(e) {
      const container = document.createElement('div');
      container.className = 'thumb';
      container.style.position = 'relative';
      container.style.width = '120px';
      container.style.height = '120px';

      const img = document.createElement('img');
      img.src = e.target.result;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';

      const btn = document.createElement('button');
      btn.textContent = 'X';
      btn.style.position = 'absolute';
      btn.style.top = '5px';
      btn.style.right = '5px';
      btn.style.background = 'transparent';
      btn.style.color = '#333';
      btn.style.border = 'none';
      btn.style.borderRadius = '0';
      btn.style.padding='0';
      btn.style.cursor='pointer';
      btn.style.fontweight='bold';
      btn.style.width = '20px';
      btn.style.height = '20px';
      btn.style.fontsize='16px';
      btn.onclick = () => container.remove();

      container.appendChild(img);
      container.appendChild(btn);
      preview.appendChild(container);
    };

    reader.readAsDataURL(file);
  }
}

</script>


  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
    /* ========== Editor ========== */
    const quill = new Quill('#desc', {
      theme: 'snow',
      placeholder: '건물 특징, 옵션(엘리베이터/주차/반려동물), 주변 편의시설 등을 입력하세요.',
      modules: { toolbar: [[{ header: [2,3,false]}], ['bold','italic','underline'], [{ list:'ordered'},{ list:'bullet'}]] }
    });
    function cleanedHtml(){
      const html = quill.root.innerHTML || '';
      const doc = new DOMParser().parseFromString(html,'text/html');
      doc.querySelectorAll('img').forEach(img => { if (img.src?.startsWith('data:')) img.remove(); });
      return doc.body.innerHTML.trim();
    }

    function resetForm(){
  // 기본 정보 폼 전체 초기화
  document.getElementById('formInfo').reset();
  
  // Quill 에디터 초기화
  quill.root.innerHTML = '';

  // 세그먼트 버튼 초기화
  setActive('type', typeSel, '');
  setActive('deal', dealSel, '');

  // 동적 필드 숨기기
  hideAllArea();
  refreshFields();
}


    /* ========== Segmented controls ========== */
    const typeSel = document.getElementById('typeSel');
    const dealSel = document.getElementById('dealSel');
    const typeBtns = [...document.querySelectorAll('#typeGroup .seg-btn')];
    const dealBtns = [...document.querySelectorAll('#dealGroup .seg-btn')];

    function setActive(group, selectEl, value){
      const btns = group === 'type' ? typeBtns : dealBtns;
      btns.forEach(b => {
        const on = b.dataset.value === value;
        b.setAttribute('aria-checked', on ? 'true' : 'false');
        b.tabIndex = on ? 0 : -1;
      });
      selectEl.value = value || '';
      refreshFields();
    }
    typeBtns.forEach((b, i) => { b.onclick = () => setActive('type', typeSel, b.dataset.value); });
    dealBtns.forEach((b, i) => { b.onclick = () => setActive('deal', dealSel, b.dataset.value); });

    /* ========== Dynamic fields by type & deal ========== */
    const priceField = document.getElementById('priceField');
    const priceLabel = document.getElementById('priceLabel');
    const priceInput = document.getElementById('price');
    const depositField = document.getElementById('depositField');
    const depositInput = document.getElementById('deposit');
    const annualField = document.getElementById('annualField');
    const annualInput = document.getElementById('annual');

    const exclusiveAreaField = document.getElementById('exclusiveAreaField');
    const exclusiveAreaInput = document.getElementById('exclusiveArea');
    const grossAreaField = document.getElementById('grossAreaField');
    const grossAreaInput = document.getElementById('grossArea');
    const landAreaField = document.getElementById('landAreaField');
    const landAreaInput = document.getElementById('landArea');
    const landRightAreaField = document.getElementById('landRightAreaField');
    const landRightAreaInput = document.getElementById('landRightArea');
    const floorField = document.getElementById('floorField');
    const floorInput = document.getElementById('floor');

    function hideAllArea(){
      [exclusiveAreaField, grossAreaField, landAreaField, landRightAreaField, floorField].forEach(el => el.classList.add('hidden'));
      [exclusiveAreaInput, grossAreaInput, landAreaInput, landRightAreaInput, floorInput].forEach(el => el.required = false);
    }

    function refreshFields(){
  const deal = dealSel.value;

  // 기본적으로 모두 숨기기
  priceField.classList.add('hidden');
  depositField.classList.add('hidden');
  annualField.classList.add('hidden');

  // placeholder 초기화
  priceInput.placeholder = '';
  depositInput.placeholder = '';
  annualInput.placeholder = '';

  if (!deal) return;

  if (deal === 'sale'){
    priceField.classList.remove('hidden');
    priceLabel.textContent = '매매가(만원)';
    priceInput.placeholder = '예) 75000';
  } else if (deal === 'jeonse'){
    priceField.classList.remove('hidden');
    priceLabel.textContent = '전세(만원)';
    priceInput.placeholder = '예) 45000';
  } else if (deal === 'monthly'){
    priceField.classList.remove('hidden');
    priceLabel.textContent = '월세(만원)';
    priceInput.placeholder = '예) 50';
    depositField.classList.remove('hidden');
    depositInput.placeholder = '예) 450';
  } else if (deal === 'yearly'){
    annualField.classList.remove('hidden');
    annualInput.placeholder = '예) 500';
  }

  // 유형/거래에 따른 면적/층 노출
  hideAllArea();
  const type = typeSel.value;
  if (!type) return;

  if (type === 'house'){
    if (deal === 'sale'){
      grossAreaField.classList.remove('hidden');
      grossAreaInput.required = true;
      grossAreaInput.placeholder="예) 대지에 들어선 건축물의 바닥면적을 모두 합한 것"

      landAreaField.classList.remove('hidden');
      landAreaInput.required = true;
      landAreaInput.placeholder="예) 건물이 위치한 토지의 전체 면적"
    } else {
      exclusiveAreaField.classList.remove('hidden');
      exclusiveAreaInput.required = true;
      exclusiveAreaInput.placeholder = "예) 우리가 실제 거주하는 기본 면적"
    }
  } else if (type === 'apartment' || type === 'officetel' || type === 'villa' || type === 'new'){
    exclusiveAreaField.classList.remove('hidden');
    exclusiveAreaInput.required=true;
    exclusiveAreaInput.placeholder="예) 우리가 실제 거주하는 기본 면적"
    
    floorField.classList.remove('hidden');
    exclusiveAreaInput.required = true;
    floorInput.required = true;

    if (type === 'villa' && deal === 'sale'){
        landRightAreaField.classList.remove('hidden');
        landRightAreaInput.required = true;
        landRightAreaInput.placeholder = '예) 대지권에 해당하는 지분 비율'; 
    }

    if (type === 'house' && deal === 'sale'){
        grossAreaField.classList.remove('hidden');
        grossAreaInput.required = true;
        grossAreaInput.placeholder = '예) 대지에 들어선 건축물의 바닥면적을 모두 합한 것'; 

        landAreaField.classList.remove('hidden');
        landAreaInput.required = true;
        landAreaInput.placeholder = '예) 건물이 위치한 토지의 전체 면적'; 
    }
  }

  if(type === 'new'){ // 분양/입주권 선택 시
        dealBtns.forEach(b => {
          if(b.dataset.value === 'sale'){
            b.disabled = false;               // 매매만 활성화
            b.classList.remove('seg-disabled');
          } else {
            b.disabled = true;                // 나머지는 비활성화
            b.setAttribute('aria-checked', 'false'); // 선택 해제
            b.classList.add('seg-disabled');  // 스타일용
          }
        });
        if(deal !== 'sale') setActive('deal', dealSel, ''); // 다른 거래 선택되어 있으면 초기화
      } else { // 나머지 유형
        dealBtns.forEach(b => {
          b.disabled = false;                  // 모두 활성화
          b.classList.remove('seg-disabled');
        });
      }
}

    refreshFields();

    /* ========== Step 1: Save info ========== */
    let listingId = null;
    const toNumOrNull = v => {
      if (v === undefined || v === null) return null;
      const s = String(v).trim();
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    };

    async function saveInfo(e){
      e.preventDefault();

      const title = document.getElementById('title').value.trim();
      const type  = typeSel.value;
      const deal  = dealSel.value;
      const built_year = toNumOrNull(document.getElementById('builtYear').value);
      const sigungu = document.getElementById('sigungu').value.trim();
      const road_name = document.getElementById('road_name').value.trim();
      const lot_no = document.getElementById('lot_no').value.trim();

      if (!title) return alert('건물명을 입력하세요.');
      if (!type)  return alert('건물 종류를 선택하세요.');
      if (!deal)  return alert('거래 유형을 선택하세요.');

      // 가격/보증금/연세
      const price_10k = toNumOrNull(priceInput.value);
      const deposit_10k = toNumOrNull(depositInput.value);
      const rent_annual_10k = toNumOrNull(annualInput.value);

      if (deal === 'sale' && !price_10k) return alert('매매가는 필수입니다.');
      if (deal === 'jeonse' && !price_10k) return alert('전세 보증금은 필수입니다.');
      if (deal === 'monthly' && (!price_10k || !deposit_10k)) return alert('월세는 보증금과 월세가 모두 필요합니다.');
      if (deal === 'yearly' && (!deposit_10k || !rent_annual_10k)) return alert('연세는 보증금과 연세 금액이 모두 필요합니다.');

      // 면적/층 (노출된 필드만 체크됨)
      const area_m2        = toNumOrNull(exclusiveAreaInput.value);
      const gross_area_m2  = toNumOrNull(grossAreaInput.value);
      const land_area_m2   = toNumOrNull(landAreaInput.value);
      const land_share_m2  = toNumOrNull(landRightAreaInput.value);
      const floor          = toNumOrNull(floorInput.value);

      // 설명 (data:image 제거)
      const description = cleanedHtml();
      if (!description || description === '<p><br></p>') return alert('상세 설명을 입력하세요.');

      const payload = {
        title, description,
        property_type_ui: type,
        deal_type_ui: deal,
        sigungu, road_name, lot_no,
        area_m2, gross_area_m2, land_area_m2, land_share_m2,
        floor, built_year,
        price_10k
      };
      if (deal === 'monthly' || deal === 'yearly') payload.deposit_10k = deposit_10k;
      if (deal === 'yearly') payload.rent_annual_10k = rent_annual_10k;

      const btn = document.getElementById('btnSaveInfo');
      btn.disabled = true;

      try{
        const res = await fetch('/api/listings', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok || !data.ok){
          alert(data.message || '저장 실패(입력값/제약조건 확인)');
          btn.disabled = false; return;
        }
        listingId = data.id;
        document.getElementById('info-sub').textContent = `저장 완료! 매물 번호 #${listingId}`;
        enableImageStep();
      }catch(e){
        console.error(e); alert('네트워크 오류');
      }finally{
        btn.disabled = false;
      }
    }

    function enableImageStep(){
      document.getElementById('imgCard').removeAttribute('aria-disabled');
      document.getElementById('imgTitle').innerHTML = `② 이미지 업로드 <span class="muted">— 매물 #${listingId}</span>`;
      document.getElementById('imgSub').textContent = '사진을 선택해 업로드하세요.';
      document.getElementById('formImages').classList.remove('hidden');
      renderGallery();
    }

    /* ========== Step 2: Images ========== */
    async function renderGallery(){
      if (!listingId) return;
      const box = document.getElementById('gallery');
      box.innerHTML = '<div class="muted">불러오는 중…</div>';
      try{
        const res = await fetch(`/api/listings/${listingId}/images`);
        const data = await res.json();
        if (!res.ok) throw new Error('load fail');
        if (!data.items?.length){ box.innerHTML = '<div class="muted">아직 업로드된 이미지가 없습니다.</div>'; return; }
        box.innerHTML = data.items.map(img => `
          <div class="thumb">
            <img src="/uploads/${img.image_url}" alt="">
            <button type="button" onclick="removeImage(${img.image_id})">삭제</button>
          </div>
        `).join('');
      }catch(e){
        console.error(e); document.getElementById('gallery').innerHTML = '<div class="muted">이미지를 불러오지 못했습니다.</div>';
      }
    }

    async function uploadImages(e){
      e.preventDefault();
      if (!listingId) return alert('먼저 ① 기본 정보를 저장하세요.');
      const input = document.getElementById('images');
      if (!input.files?.length) return alert('업로드할 이미지를 선택하세요.');
      for (const f of input.files){
        if (!f.type.startsWith('image/')) return alert('이미지 파일만 업로드할 수 있습니다.');
        if (f.size > 5*1024*1024) return alert('각 이미지 최대 5MB까지 가능합니다.');
      }
      const form = new FormData();
      [...input.files].forEach(f => form.append('images', f));
      const btn = document.getElementById('btnUpload'); btn.disabled = true;
      try{
        const res = await fetch(`/api/listings/${listingId}/images`, { method:'POST', body: form });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok || !data.ok){ alert(data.message || '업로드 실패'); return; }
        input.value=''; await renderGallery();
      }catch(e){ console.error(e); alert('네트워크 오류'); }
      finally{ btn.disabled = false; }
    }

    async function removeImage(imageId){
      if (!confirm('이 이미지를 삭제할까요?')) return;
      try{
        const res = await fetch(`/api/listings/${listingId}/images/${imageId}`, { method:'DELETE' });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok || !data.ok){ alert(data.message || '삭제 실패'); return; }
        await renderGallery();
      }catch(e){ console.error(e); alert('네트워크 오류'); }
    }

    // 초기화
    refreshFields();
  </script>
</body>
</html>